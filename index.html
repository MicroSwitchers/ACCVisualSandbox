<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AAC Visual Sandbox">
    <meta name="mobile-web-app-capable" content="yes">

    <title>AAC Visual Sandbox</title>
    <!-- Tailwind CSS for styling -->

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Core Styles */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f8fafc;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            user-select: none;
            -webkit-user-select: none;
            touch-action: pan-x pan-y;
            /* Safe area support for notched devices */
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Drawer Transitions */
        #drawer {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 32px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.04);
        }

        /* Responsive Drawer Width */
        @media (max-width: 640px) {
            #drawer {
                width: 85vw !important;
                max-width: 320px;
            }
        }

        @media (max-width: 400px) {
            #drawer {
                width: 90vw !important;
            }
        }

        .drawer-closed {
            transform: translateX(-100%);
        }

        .drawer-open {
            transform: translateX(0);
        }

        /* Grid Styles */
        #grid-container {
            display: grid;
            width: 100%;
            height: 100%;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            overflow: hidden;
            box-sizing: border-box;
            position: relative;
            /* Essential for offsetLeft/Top hit testing */
            touch-action: none;
            /* Prevent browser scrolling/zooming */
            user-select: none;
            /* Prevent text selection */
            -webkit-user-select: none;
        }

        /* Grid Item (The Cell) */
        .grid-cell {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            overflow: visible;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s, opacity 0.2s;
            touch-action: none;
            background-color: transparent;
            z-index: 1;
            /* Default z-index */
            box-sizing: border-box;
            /* Performance optimizations for mobile */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* Occupied Cell Styles */
        .grid-cell.occupied {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.08), 0 1px 2px -1px rgb(0 0 0 / 0.08);
            cursor: pointer;
        }

        .grid-cell.occupied:hover {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Empty Cell Styles (Target) */
        .grid-cell.empty {
            border: 2px dashed #cbd5e1;
        }



        /* Pop-Up Finder: show full grid outlines during game (use current border settings) */
        #grid-container.hunt-outlines .grid-cell {
            border: var(--hunt-border-width, 2px) solid var(--hunt-border-color, #cbd5e1);
            background: #ffffff;
            box-shadow: none;
        }

        #grid-container.hunt-outlines .grid-cell.occupied {
            background: #ffffff;
        }

        #grid-container.hunt-outlines .grid-cell.empty {
            /* override placeholder style during the game */
            border-style: solid;
            opacity: 1;
        }

        /* Wiggle feedback (used when voice is off) */
        @keyframes wiggle {
            0% {
                transform: translateX(0) rotate(0deg);
            }

            20% {
                transform: translateX(-3px) rotate(-2deg);
            }

            40% {
                transform: translateX(3px) rotate(2deg);
            }

            60% {
                transform: translateX(-2px) rotate(-1deg);
            }

            80% {
                transform: translateX(2px) rotate(1deg);
            }

            100% {
                transform: translateX(0) rotate(0deg);
            }
        }

        .wiggle {
            animation: wiggle 0.35s ease-in-out;
        }

        /* Gentle Shake Animation (Game Success) */
        @keyframes gentle-shake {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-3deg);
            }

            50% {
                transform: rotate(3deg);
            }

            75% {
                transform: rotate(-3deg);
            }
        }

        .gentle-shake {
            animation: gentle-shake 0.5s ease-in-out;
        }

        /* Edit Mode Interactions */
        .grid-cell.occupied.editable {
            cursor: grab;
        }

        .grid-cell.occupied.editable:active {
            cursor: grabbing;
        }

        /* Play Mode Interactions */
        .grid-cell.occupied.locked {
            cursor: pointer;
        }

        /* Magnification Effect */
        .grid-cell.magnified {
            z-index: 100 !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            border-color: #3b82f6;
            will-change: transform;
            /* Force hardware acceleration */
            transform: translateZ(0) scale(var(--zoom-level, 1.5));
        }

        /* Hiding dashed lines in play mode */
        .play-mode .grid-cell.empty {
            border: none;
        }

        /* Image Styling */
        /* Inner content wrapper - visible overflow for labels */
        .grid-cell .cell-content {
            position: absolute;
            inset: 0;
            overflow: visible;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-cell .image-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: auto;
            max-height: 100%;
            padding: 4px;
            overflow: visible;
        }

        .grid-cell img {
            flex: 1 1 auto;
            min-height: 0;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            pointer-events: none;
            border-radius: 4px;
        }

        .grid-cell .label-text {
            position: relative;
            width: 100%;
            font-size: 0.875rem;
            font-weight: 700;
            color: #000000;
            text-align: center;
            padding: 4px;
            border-radius: 4px;
            background: transparent;
            overflow: visible;
            overflow-wrap: break-word;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.2;
            pointer-events: none;
            z-index: 2;
        }

        /* Contour Effect for Text-Only Cells (Word Bubbling - Dr. Roman-Lanzy Method) */
        .text-cell-contour {
            position: relative;
            z-index: 10;
            /* Enable GPU acceleration for smoother filter rendering */
            transform: translateZ(0);
            -webkit-font-smoothing: antialiased;
        }

        .text-cell-contour::after {
            /* The Gap Layer (Inner Stroke via Dilate Filter) */
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            filter: var(--contour-filter-gap);
            /* Smooth rendering */
            -webkit-font-smoothing: antialiased;
            text-rendering: geometricPrecision;
        }

        .text-cell-contour::before {
            /* The Outline Layer (Outer Stroke via Dilate Filter) */
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            filter: var(--contour-filter-outline);
            /* Smooth rendering */
            -webkit-font-smoothing: antialiased;
            text-rendering: geometricPrecision;
        }

        /* Text-only cell (no image) */
        .grid-cell.text-only-cell {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-cell.text-only-cell .text-only-label {
            font-size: 2.5rem;
            /* Initial size, will be adjusted dynamically */
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            max-width: 95%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            text-align: center;
            line-height: 1.1;
        }

        /* Generic Image Container for Image/Arasaac/Mulberry cells */
        .image-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Shape cell (emoji/symbol) */
        .grid-cell.shape-cell {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-cell.shape-cell .image-container {
            height: auto;
            flex-shrink: 0;
        }

        .grid-cell.shape-cell .shape-symbol {
            font-size: 4rem;
            /* Will be dynamically adjusted */
            line-height: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Shape picker buttons */
        .shape-btn {
            width: 100%;
            aspect-ratio: 1;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .shape-btn:hover {
            background: #e0f2fe;
            border-color: #3b82f6;
            transform: scale(1.1);
        }

        /* Delete Button */
        .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 28px;
            height: 28px;
            min-width: 28px;
            min-height: 28px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 20;
            transition: transform 0.1s;
        }

        .delete-btn:hover {
            background-color: #dc2626;
            transform: scale(1.1);
        }

        .delete-btn svg {
            width: 14px;
            height: 14px;
            pointer-events: none;
        }

        /* Preview Button */
        .preview-btn {
            position: absolute;
            top: 36px;
            right: 4px;
            width: 28px;
            height: 28px;
            min-width: 28px;
            min-height: 28px;
            background-color: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 20;
            transition: transform 0.1s;
        }

        .preview-btn:hover {
            background-color: #2563eb;
            transform: scale(1.1);
        }

        .preview-btn svg {
            width: 14px;
            height: 14px;
            pointer-events: none;
        }

        /* Speech Label Button */
        .label-btn {
            position: absolute;
            top: 68px;
            right: 4px;
            width: 28px;
            height: 28px;
            min-width: 28px;
            min-height: 28px;
            background-color: #8b5cf6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 20;
            transition: transform 0.1s;
        }

        .label-btn:hover {
            background-color: #7c3aed;
            transform: scale(1.1);
        }

        .label-btn svg {
            width: 14px;
            height: 14px;
            pointer-events: none;
        }

        .label-btn.has-label {
            background-color: #10b981;
        }

        .label-btn.has-label:hover {
            background-color: #059669;
        }

        /* Symbol Color Button */
        .color-pick-btn {
            position: absolute;
            top: 100px;
            right: 4px;
            width: 28px;
            height: 28px;
            min-width: 28px;
            min-height: 28px;
            background-color: #f59e0b;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 20;
            transition: transform 0.1s;
        }

        .color-pick-btn:hover {
            background-color: #d97706;
            transform: scale(1.1);
        }

        .color-pick-btn svg {
            width: 14px;
            height: 14px;
            pointer-events: none;
        }

        .color-pick-btn.has-custom {
            background-color: #10b981;
        }

        .color-pick-btn.has-custom:hover {
            background-color: #059669;
        }

        /* Compact Button Mode (for 4+ rows) */
        .compact-buttons .delete-btn,
        .compact-buttons .preview-btn,
        .compact-buttons .label-btn,
        .compact-buttons .color-pick-btn {
            width: 22px;
            height: 22px;
            min-width: 22px;
            min-height: 22px;
        }

        .compact-buttons .delete-btn svg,
        .compact-buttons .preview-btn svg,
        .compact-buttons .label-btn svg,
        .compact-buttons .color-pick-btn svg {
            width: 12px;
            height: 12px;
        }

        /* 2x2 grid arrangement */
        .compact-buttons .delete-btn {
            top: 2px;
            right: 28px;
        }

        .compact-buttons .preview-btn {
            top: 2px;
            right: 2px;
        }

        .compact-buttons .label-btn {
            top: 28px;
            right: 28px;
        }

        .compact-buttons .color-pick-btn {
            top: 28px;
            right: 2px;
        }

        /* Drag and Drop Visual States */
        .dragging {
            opacity: 0.4;
        }

        .drag-over {
            border: 4px solid #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.1);
            z-index: 10;
            transform: scale(1.02);
        }

        /* Color Selection */
        .color-btn.selected {
            box-shadow: 0 0 0 2px #3b82f6;
            transform: scale(1.1);
            border-color: #3b82f6;
        }

        /* Toggle Switch Styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #3b82f6;
        }

        /* Unlock Animation for Open Button */
        #open-btn {
            transition: background-color 0.2s, color 0.2s, transform 0.2s;
        }

        #open-btn.unlocking {
            background-color: #3b82f6 !important;
            color: white !important;
            transition: background-color 3s linear, color 3s linear;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease-out;
            cursor: pointer;
            /* Click to dismiss */
        }

        /* Robust hidden state */
        #loading-overlay.hidden {
            display: none !important;
            pointer-events: none !important;
            visibility: hidden !important;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Landscape Mode Optimization for Phones */
        @media (max-height: 500px) and (orientation: landscape) {
            #drawer {
                width: 60vw !important;
                max-width: 280px;
            }

            .p-6 {
                padding: 1rem !important;
            }

            .space-y-8>*+* {
                margin-top: 1.25rem !important;
            }
        }

        .label-text {
            pointer-events: none;
            width: 100%;
            text-align: center;
            white-space: normal;
            overflow: visible;
            overflow-wrap: break-word;
            word-wrap: break-word;
            padding: 2px 4px;
            background: rgba(255, 255, 255, 0.7);
            position: relative;
            flex-shrink: 0;
        }

        /* Minimum Touch Target Sizes (44px x 44px for accessibility) */
        button,
        .color-btn,
        input[type="range"],
        select {
            min-height: 44px;
            min-width: 44px;
            touch-action: none;
            /* Prevent scrolling while sliding */
        }

        /* Custom Slider Styling for better touch targets */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25), 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-top: -8px;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35), 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        input[type=range]::-webkit-slider-thumb:active {
            transform: scale(0.95);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: linear-gradient(to right, #e2e8f0, #cbd5e1);
            border-radius: 9999px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2), 0 2px 8px rgba(59, 130, 246, 0.25);
        }

        .color-btn {
            width: 44px;
            height: 44px;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .color-btn:hover {
            transform: scale(1.05);
        }

        .color-btn:active {
            transform: scale(0.95);
        }

        /* Pulse Animation for Play Mode */
        @keyframes pulse-feedback {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
            }

            100% {
                transform: scale(1);
            }
        }

        .pulse-active {
            animation: pulse-feedback 0.5s ease-in-out;
            z-index: 150 !important;
            position: relative;
        }

        /* Game Mode Pop-Out Animation */
        @keyframes game-pop {
            0% {
                transform: scale(1);
                box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            }

            40% {
                transform: scale(1.25);
                box-shadow: 0 0 30px rgba(34, 197, 94, 0.8), 0 0 50px rgba(34, 197, 94, 0.4);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            }
        }

        .game-pop {
            animation: game-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 200 !important;
            position: relative;
        }

        /* Drawer Animation */
        #drawer {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .drawer-open {
            transform: translateX(0);
        }

        .drawer-closed {
            transform: translateX(-100%);
        }

        /* Wiggle Animation - No Scale */
        .single-wiggle {
            animation: single-wiggle 0.5s ease-in-out;
            transform-origin: center;
        }

        @keyframes single-wiggle {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-5deg);
            }

            75% {
                transform: rotate(5deg);
            }
        }

        /* Focus Visible States for Accessibility */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Smooth transitions for interactive elements */
        button,
        select,
        input,
        .grid-cell {
            transition: all 0.15s ease;
        }

        /* Improved select dropdown styling */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Delete button hover glow */
        .delete-btn:hover {
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.4);
        }

        /* Preview button hover glow */
        .preview-btn:hover {
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
        }

        /* Label button hover glow */
        .label-btn:hover {
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.4);
        }

        /* Color pick button hover glow */
        .color-pick-btn:hover {
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.4);
        }

        /* Better scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 9999px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ARASAAC Symbol Picker Styles */
        .arasaac-search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .arasaac-search-input:focus {
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .arasaac-search-wrapper {
            position: relative;
        }

        .arasaac-search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
        }

        .arasaac-results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            min-height: 200px;
        }

        @media (max-width: 480px) {
            .arasaac-results-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .arasaac-symbol-btn {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
        }

        .arasaac-symbol-btn:hover {
            background: #eff6ff;
            border-color: #3b82f6;
            transform: scale(1.02);
        }

        .arasaac-symbol-btn:active {
            transform: scale(0.98);
        }

        .arasaac-symbol-btn img {
            width: 100%;
            height: 70%;
            object-fit: contain;
        }

        .arasaac-symbol-btn .symbol-label {
            font-size: 0.65rem;
            color: #64748b;
            text-align: center;
            margin-top: 4px;
            line-height: 1.1;
            max-height: 2.2em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .arasaac-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #64748b;
            grid-column: 1 / -1;
        }

        .arasaac-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: arasaac-spin 1s linear infinite;
        }

        @keyframes arasaac-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .arasaac-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #94a3b8;
            text-align: center;
            grid-column: 1 / -1;
        }

        .arasaac-empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .arasaac-attribution {
            font-size: 0.7rem;
            color: #94a3b8;
            text-align: center;
            padding: 8px 16px;
            background: linear-gradient(to right, #f8fafc, #f1f5f9, #f8fafc);
            border-top: 1px solid #e2e8f0;
        }

        .arasaac-attribution a {
            color: #3b82f6;
            text-decoration: none;
        }

        .arasaac-attribution a:hover {
            text-decoration: underline;
        }

        /* Symbol picker tabs */
        .symbol-picker-tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: #f1f5f9;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .symbol-picker-tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .symbol-picker-tab:hover {
            color: #334155;
        }

        .symbol-picker-tab.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .symbol-picker-tab svg {
            width: 18px;
            height: 18px;
        }

        .symbol-tab-content {
            display: none;
        }

        .symbol-tab-content.active {
            display: block;
        }

        .arasaac-popular-symbols {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .arasaac-popular-btn {
            padding: 6px 12px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            font-size: 0.75rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s;
        }

        .arasaac-popular-btn:hover {
            background: #e0f2fe;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        /* Mulberry Symbol Picker Styles */
        .mulberry-search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .mulberry-search-input:focus {
            border-color: #10b981;
            background: white;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .mulberry-search-wrapper {
            position: relative;
        }

        .mulberry-search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
        }

        .mulberry-results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            min-height: 200px;
        }

        @media (max-width: 480px) {
            .mulberry-results-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .mulberry-symbol-btn {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
        }

        .mulberry-symbol-btn:hover {
            background: #ecfdf5;
            border-color: #10b981;
            transform: scale(1.02);
        }

        .mulberry-symbol-btn:active {
            transform: scale(0.98);
        }

        .mulberry-symbol-btn img {
            width: 100%;
            height: 70%;
            object-fit: contain;
        }

        .mulberry-symbol-btn .symbol-label {
            font-size: 0.65rem;
            color: #64748b;
            text-align: center;
            margin-top: 4px;
            line-height: 1.1;
            max-height: 2.2em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .mulberry-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #64748b;
            grid-column: 1 / -1;
        }

        .mulberry-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #10b981;
            border-radius: 50%;
            animation: mulberry-spin 1s linear infinite;
        }

        @keyframes mulberry-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .mulberry-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #94a3b8;
            text-align: center;
            grid-column: 1 / -1;
        }

        .mulberry-empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .mulberry-attribution {
            font-size: 0.7rem;
            color: #94a3b8;
            text-align: center;
            padding: 8px 16px;
            background: linear-gradient(to right, #f8fafc, #ecfdf5, #f8fafc);
            border-top: 1px solid #d1fae5;
        }

        .mulberry-attribution a {
            color: #10b981;
            text-decoration: none;
        }

        .mulberry-attribution a:hover {
            text-decoration: underline;
        }

        .mulberry-popular-symbols {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .mulberry-popular-btn {
            padding: 6px 12px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            font-size: 0.75rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s;
        }

        .mulberry-popular-btn:hover {
            background: #d1fae5;
            border-color: #10b981;
            color: #059669;
        }

        /* Mulberry image in grid cells */
        .mulberry-image {
            /* SVG images from Mulberry work well at any size */
            image-rendering: auto;
        }
    </style>
    <style>
        /* Splash Screen Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes progress {
            0% {
                width: 0%;
            }

            100% {
                width: 100%;
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .animate-progress {
            animation: progress 2.5s ease-out forwards;
        }

        .splash-hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>

    <script>
        // Splash logic moved to end of body
    </script>
</head>

<body>

    <!-- Hunt Picker Modal -->
    <div id="hunt-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeHuntModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-200 flex items-center justify-between">
                    <div>
                        <div class="text-sm font-bold text-slate-800">Choose a picture for Pop-Up Finder</div>
                        <div class="text-xs text-slate-500">Select an existing symbol, or load a new image.</div>
                    </div>
                    <button class="p-2 rounded-lg hover:bg-slate-100" onclick="closeHuntModal()" aria-label="Close">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <div class="p-4 space-y-3">
                    <div id="hunt-picker-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>

                    <div class="flex items-center justify-between pt-2 border-t border-slate-200">
                        <button
                            class="px-4 py-2 text-sm font-semibold bg-white border border-slate-300 shadow-sm hover:bg-slate-50 hover:border-slate-400 text-slate-700 rounded-lg transition-all active:scale-95"
                            onclick="triggerHuntLoad()">
                            Load Image
                        </button>
                        <button
                            class="px-3 py-2 text-sm font-semibold bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg"
                            onclick="confirmHuntChoice()" id="hunt-confirm-btn" disabled>
                            Use Selected
                        </button>
                    </div>

                    <div id="hunt-picker-hint" class="text-xs text-slate-500"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Symbol Modal -->
    <div id="bulk-symbol-modal" class="fixed inset-0 z-[100] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"
            onclick="closeBulkSymbolModal()">
        </div>

        <!-- Modal Content -->
        <div
            class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center pointer-events-none">
            <div
                class="bg-white w-full md:w-[800px] md:h-[80vh] md:rounded-2xl shadow-2xl flex flex-col h-[90vh] pointer-events-auto transform transition-transform duration-300 translate-y-full md:translate-y-0">

                <!-- Header -->
                <div
                    class="flex items-center justify-between p-4 border-b border-slate-100 bg-slate-50 md:rounded-t-2xl">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">Bulk Add Symbols</h3>
                        <p class="text-xs text-slate-500">Search and collect multiple symbols to add at once</p>
                    </div>
                    <button onclick="closeBulkSymbolModal()"
                        class="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Tabs -->
                <div class="symbol-picker-tabs mx-4 mt-2">
                    <button id="bulk-tab-arasaac" class="symbol-picker-tab active"
                        onclick="switchBulkSymbolTab('arasaac')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                            <path d="M2 2l7.586 7.586"></path>
                            <circle cx="11" cy="11" r="2"></circle>
                        </svg>
                        <span class="flex flex-col items-start leading-tight">
                            <span class="font-semibold">ARASAAC</span>
                            <span class="text-xs opacity-70">Line Drawings</span>
                        </span>
                    </button>
                    <button id="bulk-tab-mulberry" class="symbol-picker-tab" onclick="switchBulkSymbolTab('mulberry')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <span class="flex flex-col items-start leading-tight">
                            <span class="font-semibold">PiCom AI</span>
                            <span class="text-xs opacity-70">Photographs</span>
                        </span>
                    </button>
                </div>

                <!-- Main Content Area (Split View: Search Results | Collection) -->
                <div class="flex-1 overflow-hidden flex flex-col md:flex-row">

                    <!-- LEFT: Search Area -->
                    <div class="flex-1 flex flex-col overflow-hidden border-r border-slate-200">
                        <!-- Search Bar -->
                        <div class="p-4 bg-white border-b border-slate-100">
                            <div class="relative">
                                <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
                                    xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                <input type="text" id="bulk-search-input"
                                    class="w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                    placeholder="Search symbols..." autocomplete="off">
                            </div>

                            <!-- Popular Searches (Dynamic based on tab) -->
                            <div id="bulk-popular-tags" class="mt-3 flex flex-wrap gap-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Results Grid -->
                        <div id="bulk-results-container" class="flex-1 overflow-y-auto p-4 bg-slate-50/50">
                            <div id="bulk-search-results"
                                class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-4 lg:grid-cols-5 gap-3">
                                <!-- Results populated here -->
                                <div
                                    class="col-span-full flex flex-col items-center justify-center py-12 text-slate-400 opacity-60">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                        stroke-linejoin="round" class="mb-2">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                    <p>Type to search symbols</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Collection Tray (Visible as sidebar on Desktop, Bottom sheet on Mobile) -->
                    <div
                        class="h-48 md:h-auto md:w-64 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] md:shadow-none flex flex-col z-10 transition-all">
                        <div class="p-3 bg-blue-50/50 border-b border-blue-100 flex justify-between items-center">
                            <h4 class="font-bold text-blue-900 text-sm">Collection Library</h4>
                            <span id="bulk-count-badge"
                                class="bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                        </div>

                        <!-- Collected Items List -->
                        <div id="bulk-collection-list" class="flex-1 overflow-y-auto p-3 space-y-2 bg-white">
                            <!-- Empty State -->
                            <div id="bulk-collection-empty"
                                class="h-full flex flex-col items-center justify-center text-slate-400 text-center p-4">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round" class="mb-2 opacity-50">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" x2="12" y1="3" y2="15"></line>
                                </svg>
                                <p class="text-xs">Select symbols to build your library</p>
                            </div>
                        </div>

                        <!-- Footer Actions -->
                        <div class="p-3 border-t border-slate-100 bg-slate-50">
                            <button onclick="confirmBulkImport()" id="bulk-import-btn" disabled
                                class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold rounded-xl shadow-lg shadow-blue-600/20 transition-all active:scale-[0.98]">
                                Import All
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Splash Screen -->
    <!-- Splash Screen -->
    <!-- Splash Screen -->
    <!-- Splash Screen -->
    <div id="splash-screen"
        class="fixed inset-0 z-[9999] bg-slate-50 flex flex-col items-center justify-center p-4 transition-opacity duration-700 overflow-y-auto">
        <div
            class="bg-white/95 backdrop-blur-md p-8 rounded-3xl shadow-2xl shadow-slate-900/10 max-w-lg w-full border border-white/60 animate-fade-in-up my-auto">
            <div class="text-center space-y-4">
                <!-- Logo -->
                <div class="relative w-28 h-28 mx-auto mb-3">
                    <img src="icon.svg" alt="AAC Visual Sandbox Logo"
                        class="w-full h-full object-contain drop-shadow-2xl">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-blue-500/20 to-indigo-500/20 rounded-full blur-2xl -z-10 scale-150">
                    </div>
                </div>

                <!-- Title -->
                <div>
                    <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 tracking-tight">
                        AAC Visual <span
                            class="bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">Sandbox</span>
                    </h1>
                    <p class="text-base text-slate-500 max-w-md mx-auto font-medium leading-relaxed mt-1">
                        Arrange images and symbols for AAC interaction.
                    </p>
                </div>

                <!-- Audio Settings Section -->
                <div
                    class="bg-gradient-to-br from-slate-50 to-slate-100/80 rounded-2xl p-5 border border-slate-200/80 text-left space-y-4 shadow-inner">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-slate-800 text-base">Feedback Style</h3>
                            <p class="text-xs text-slate-500">How should the app respond to touch?</p>
                        </div>

                        <!-- Toggle Switch with Labels -->
                        <div class="flex items-center gap-2">
                            <span
                                class="text-[10px] font-bold uppercase tracking-wider text-slate-400 transition-colors"
                                id="label-tone">Tone</span>

                            <div
                                class="relative inline-block w-12 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="splash-audio-toggle" id="splash-audio-toggle"
                                    class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" />
                                <label for="splash-audio-toggle"
                                    class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                            </div>

                            <span class="text-[10px] font-bold uppercase tracking-wider text-blue-600 transition-colors"
                                id="label-voice">Voice</span>
                        </div>
                    </div>

                    <!-- Help Triggers -->
                    <div class="flex flex-col items-start gap-y-3 pt-2">
                        <button id="splash-help-btn"
                            class="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            How does naming work?
                        </button>
                        <button id="splash-image-help-btn"
                            class="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
                                <circle cx="9" cy="9" r="2" />
                                <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
                            </svg>
                            What image Formats can be used?
                        </button>
                    </div>

                </div>

                <!-- Action Button -->
                <button id="splash-start-btn"
                    class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold text-lg rounded-xl shadow-lg shadow-blue-500/25 transition-all hover:scale-[1.02] hover:shadow-xl hover:shadow-blue-500/30 active:scale-[0.98]">
                    Start Creating
                </button>
            </div>
        </div>
    </div>

    <!-- Splash Help Modal -->
    <div id="splash-help-modal"
        class="fixed inset-0 z-[10000] bg-black/50 backdrop-blur-sm hidden overflow-y-auto opacity-0 transition-opacity duration-300">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full p-6 transform scale-95 transition-transform duration-300"
                id="splash-help-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-800">How Naming Works</h3>
                    <button id="splash-help-close" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <p class="text-slate-600 text-sm mb-4 leading-relaxed">
                    There are two ways to assign what the app says when a symbol is clicked:
                </p>

                <div class="grid md:grid-cols-2 gap-4">
                    <!-- Method 1: Filename -->
                    <div class="bg-slate-50 p-4 rounded-xl border-2 border-slate-300 flex flex-col">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-600"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z">
                                    </path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                            </div>
                            <h4 class="font-bold text-slate-800">Using Filenames</h4>
                        </div>

                        <div class="space-y-3 text-slate-600 flex-1">
                            <div>
                                <p class="font-semibold text-slate-900 text-sm">Basic Naming</p>
                                <p class="text-sm mt-1">Name the file exactly what you want spoken.</p>
                                <code
                                    class="block mt-1 bg-white px-2 py-1 rounded border border-slate-200 text-xs text-blue-600 font-mono">bear.png &rarr; speaks "Bear"</code>
                            </div>

                            <div>
                                <p class="font-semibold text-slate-900 text-sm">Variations</p>
                                <p class="text-sm mt-1">Use a dash <code
                                        class="bg-white px-1 rounded border border-slate-200 text-xs">-</code> to add
                                    descriptions that won't be spoken.</p>
                                <code
                                    class="block mt-1 bg-white px-2 py-1 rounded border border-slate-200 text-xs text-blue-600 font-mono">ball - red.jpg &rarr; speaks "Ball"</code>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-t border-slate-200">
                            <div class="flex items-start gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                <p class="text-xs text-green-700"><strong>Recommended:</strong> This is the most
                                    reliable
                                    and permanent way to assign words. Labels travel with your files.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Method 2: Pencil Icon -->
                    <div class="bg-violet-50 p-4 rounded-xl border-2 border-slate-300 flex flex-col">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 rounded-full bg-violet-100 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-violet-600"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 20h9"></path>
                                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                                </svg>
                            </div>
                            <h4 class="font-bold text-slate-800">Using the Pencil Icon</h4>
                        </div>

                        <div class="space-y-3 text-slate-600 flex-1">
                            <div>
                                <p class="font-semibold text-slate-900 text-sm">Custom Speech Labels</p>
                                <p class="text-sm mt-1">Click the purple pencil icon beside each image to type a custom
                                    label that overrides the filename.</p>
                            </div>

                            <div>
                                <p class="font-semibold text-slate-900 text-sm">How It Works</p>
                                <p class="text-sm mt-1">The label is saved in your browser's memory. When you load the
                                    same
                                    file again, the label is automatically restored.</p>
                            </div>

                            <div>
                                <p class="font-semibold text-slate-900 text-sm">Clearing Labels</p>
                                <p class="text-sm mt-1">Click the pencil icon and choose "Clear Label" to return to
                                    using
                                    the filename.</p>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-t border-slate-300">
                            <div class="flex items-start gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="w-4 h-4 text-amber-600 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                                <p class="text-xs text-amber-700"><strong>Note:</strong> Labels are stored in this
                                    browser
                                    only. They may work when re-importing files, but are not embedded in the file and
                                    are
                                    not portable to other devices.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                    <button id="splash-help-ok-btn"
                        class="px-5 py-2 bg-slate-800 hover:bg-slate-900 text-white font-medium rounded-lg transition-colors">
                        Got it
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Splash Image Help Modal -->
    <div id="splash-image-help-modal"
        class="fixed inset-0 z-[10000] bg-black/50 backdrop-blur-sm hidden overflow-y-auto opacity-0 transition-opacity duration-300">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform scale-95 transition-transform duration-300 relative"
                id="splash-image-help-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-800">Supported Images</h3>
                    <button id="splash-image-help-close" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="space-y-4 text-slate-600 text-sm leading-relaxed">
                    <p>
                        You can upload almost any image from your device or internet browser.
                    </p>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <p class="font-bold text-slate-900 mb-1">Formats</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>.JPG / .JPEG</li>
                                <li>.PNG (preferred)</li>
                                <li>.WEBP</li>
                                <li>.GIF</li>
                            </ul>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <p class="font-bold text-slate-900 mb-1">Best Practices</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>Square or near square</li>
                                <li>Simple drawings</li>
                                <li>Transparent or white background</li>
                            </ul>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <p class="text-blue-800 text-xs font-medium">
                            <strong>Tip:</strong> You can upload multiple files at once to fill the grid quickly!
                        </p>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                    <button id="splash-image-help-ok-btn"
                        class="px-5 py-2 bg-slate-800 hover:bg-slate-900 text-white font-medium rounded-lg transition-colors">
                        Got it
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay (Click to force dismiss) -->
    <div id="loading-overlay" class="hidden" title="Tap to cancel">
        <div class="spinner mb-5"></div>
        <p class="text-slate-700 font-semibold text-lg">Processing...</p>
        <p class="text-slate-500 text-sm mt-1">Tap anywhere to cancel</p>
    </div>

    <!-- Toggle Button (Drawer Handle) -->
    <button id="open-btn"
        class="fixed z-50 p-2.5 bg-white rounded-xl shadow-lg hover:bg-slate-50 text-slate-600 hidden border border-slate-200/50 hover:shadow-xl transition-all active:scale-95"
        style="top: max(1rem, env(safe-area-inset-top, 1rem)); left: max(1rem, env(safe-area-inset-left, 1rem));">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" x2="20" y1="12" y2="12" />
            <line x1="4" x2="20" y1="6" y2="6" />
            <line x1="4" x2="20" y1="18" y2="18" />
        </svg>
    </button>

    <!-- Settings Drawer -->
    <aside id="drawer"
        class="fixed inset-y-0 left-0 z-50 w-80 bg-white shadow-2xl flex flex-col drawer-open overflow-hidden border-r border-slate-200/80"
        style="padding-top: env(safe-area-inset-top, 0); padding-bottom: env(safe-area-inset-bottom, 0);">
        <!-- Header -->
        <div
            class="p-4 border-b border-slate-200 flex justify-between items-center bg-gradient-to-r from-slate-50 to-blue-50/50">
            <h2 class="font-bold text-slate-800 text-lg tracking-tight">AAC Visual Sandbox</h2>
            <button id="close-btn"
                class="p-2 hover:bg-slate-200/80 rounded-lg text-slate-500 hover:text-slate-700 transition-all flex items-center justify-center active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18" />
                    <path d="m6 6 12 12" />
                </svg>
            </button>
        </div>

        <!-- Controls -->
        <div class="flex-1 overflow-y-auto p-6 space-y-8"
            style="-webkit-overflow-scrolling: touch; overscroll-behavior: contain;">

            <!-- Fullscreen Toggle (Top Priority) -->
            <button onclick="toggleFullScreen()"
                class="w-full py-2.5 bg-gradient-to-r from-slate-800 to-slate-900 text-white rounded-xl hover:from-slate-900 hover:to-slate-950 transition-all text-sm font-semibold flex justify-center items-center gap-2 shadow-md hover:shadow-lg active:scale-[0.98]">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 3h6v6" />
                    <path d="M9 21H3v-6" />
                    <path d="M21 3l-7 7" />
                    <path d="M3 21l7-7" />
                </svg>
                Toggle Fullscreen
            </button>

            <!-- Mode Toggle -->
            <div class="bg-slate-100 p-1.5 rounded-xl flex shadow-inner border border-slate-200/50">
                <button id="btn-mode-edit" onclick="setMode('edit')"
                    class="mode-btn flex-1 py-2.5 rounded-lg text-sm font-bold shadow-sm bg-white text-blue-600 flex items-center justify-center gap-2 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                    Edit
                </button>
                <button id="btn-mode-play" onclick="setMode('play')"
                    class="mode-btn flex-1 py-2.5 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 flex items-center justify-center gap-2 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    Play
                </button>
            </div>

            <!-- Upload (Only visible in Edit Mode) -->
            <div id="section-upload" class="space-y-2 transition-opacity duration-300">
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider">1. Images &
                    Symbols</label>

                <div class="grid grid-cols-2 gap-3">
                    <!-- Upload Button -->
                    <div onclick="document.getElementById('file-input').click()"
                        class="aspect-square border-2 border-dashed border-slate-300 rounded-2xl p-4 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-blue-50/50 transition-all duration-200 group hover:shadow-sm">
                        <svg class="text-slate-400 group-hover:text-blue-500 mb-2" xmlns="http://www.w3.org/2000/svg"
                            width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" x2="12" y1="3" y2="15" />
                        </svg>
                        <span
                            class="text-xs font-bold text-slate-600 group-hover:text-blue-600 text-center leading-tight">Upload<br>Photos</span>
                    </div>

                    <!-- Bulk Button -->
                    <div onclick="openBulkSymbolModal()"
                        class="aspect-square border-2 border-dashed border-slate-300 rounded-2xl p-4 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-blue-50/50 transition-all duration-200 group hover:shadow-sm">
                        <svg class="text-slate-400 group-hover:text-blue-500 mb-2" xmlns="http://www.w3.org/2000/svg"
                            width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
                            <line x1="12" x2="12" y1="8" y2="16"></line>
                            <line x1="8" x2="16" y1="12" y2="12"></line>
                        </svg>
                        <span
                            class="text-xs font-bold text-slate-600 group-hover:text-blue-600 text-center leading-tight">Bulk<br>Symbols</span>
                    </div>
                </div>

                <input type="file" id="file-input" class="hidden" multiple accept="image/*">
                <!-- Hidden input for single cell upload -->
                <input type="file" id="single-file-input" class="hidden" accept="image/*">

                <div id="file-status" class="hidden flex justify-between items-center bg-slate-100 p-2 rounded-lg mt-2">
                    <span id="file-count" class="text-xs font-bold text-slate-500 px-2">0 images</span>
                </div>

                <!-- Clear All Button (always visible in edit mode when there's data) -->
                <button id="clear-all-btn" onclick="clearGrid()"
                    class="hidden w-full mt-3 py-3 px-4 bg-red-50 hover:bg-red-100 border border-red-200 hover:border-red-300 text-red-600 hover:text-red-700 rounded-xl transition-all text-sm font-semibold flex items-center justify-center gap-2 active:scale-[0.98]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18" />
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                        <line x1="10" x2="10" y1="11" y2="17" />
                        <line x1="14" x2="14" y1="11" y2="17" />
                    </svg>
                    Clear All Symbols
                </button>
            </div>

            <!-- Hidden Icons Warning Drawer -->
            <div id="hidden-icons-warning" class="hidden transition-all duration-300 ease-in-out overflow-hidden">
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 shadow-sm relative">
                    <button onclick="dismissWarning()"
                        class="absolute top-2 right-2 text-amber-400 hover:text-amber-600 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <div class="flex items-start gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <div>
                            <p class="text-sm font-bold text-amber-800">Hidden Symbols</p>
                            <p class="text-xs text-amber-700 mt-1 leading-relaxed">
                                Some icons are outside the visible grid. Increase the number of rows or columns to see
                                them, or safely ignore this message.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dimensions -->
            <div id="section-dimensions" class="space-y-6 transition-opacity duration-300">
                <!-- 1. Grid Configuration -->
                <div class="space-y-4">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Grid
                        Configuration</label>

                    <!-- Quick Layouts -->
                    <div>
                        <div class="flex justify-between items-baseline mb-3">
                            <label class="text-xs font-medium text-slate-600">Quick Layouts</label>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <!-- 1x1 -->
                            <button onclick="setGridSize(1, 1)" data-cols="1" data-rows="1"
                                class="preset-btn p-1.5 border border-slate-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-1 group"
                                title="1 Column x 1 Row">
                                <div class="grid grid-cols-1 gap-0.5 w-4 h-4 place-items-center">
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400 w-full h-full"></div>
                                </div>
                                <span
                                    class="preset-label text-[9px] font-medium text-slate-500 group-hover:text-blue-600">1x1</span>
                            </button>
                            <!-- 2x1 -->
                            <button onclick="setGridSize(2, 1)" data-cols="2" data-rows="1"
                                class="preset-btn p-1.5 border border-slate-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-1 group"
                                title="2 Columns x 1 Row">
                                <div class="grid grid-cols-2 gap-0.5 w-4 h-4">
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                </div>
                                <span
                                    class="preset-label text-[9px] font-medium text-slate-500 group-hover:text-blue-600">2x1</span>
                            </button>
                            <!-- 2x2 -->
                            <button onclick="setGridSize(2, 2)" data-cols="2" data-rows="2"
                                class="preset-btn p-1.5 border border-slate-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-1 group"
                                title="2 Columns x 2 Rows">
                                <div class="grid grid-cols-2 gap-0.5 w-4 h-4">
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                </div>
                                <span
                                    class="preset-label text-[9px] font-medium text-slate-500 group-hover:text-blue-600">2x2</span>
                            </button>
                            <!-- 3x2 -->
                            <button onclick="setGridSize(3, 2)" data-cols="3" data-rows="2"
                                class="preset-btn p-1.5 border border-slate-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-1 group"
                                title="3 Columns x 2 Rows">
                                <div class="grid grid-cols-3 gap-0.5 w-4 h-4">
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                </div>
                                <span
                                    class="preset-label text-[9px] font-medium text-slate-500 group-hover:text-blue-600">3x2</span>
                            </button>
                            <!-- 3x3 -->
                            <button onclick="setGridSize(3, 3)" data-cols="3" data-rows="3"
                                class="preset-btn p-1.5 border border-slate-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-1 group"
                                title="3 Columns x 3 Rows">
                                <div class="grid grid-cols-3 gap-0.5 w-4 h-4">
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                </div>
                                <span
                                    class="preset-label text-[9px] font-medium text-slate-500 group-hover:text-blue-600">3x3</span>
                            </button>
                            <!-- 4x3 -->
                            <button onclick="setGridSize(4, 3)" data-cols="4" data-rows="3"
                                class="preset-btn p-1.5 border border-slate-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-1 group"
                                title="4 Columns x 3 Rows">
                                <div class="grid grid-cols-4 gap-0.5 w-4 h-4">
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                    <div class="bg-slate-300 rounded-[1px] group-hover:bg-blue-400"></div>
                                </div>
                                <span
                                    class="preset-label text-[9px] font-medium text-slate-500 group-hover:text-blue-600">4x3</span>
                            </button>
                        </div>
                    </div>

                    <!-- Sliders Grid to save space -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm text-slate-700">Columns</label>
                                <span id="col-val"
                                    class="text-sm font-mono font-bold text-blue-600 bg-blue-50 px-2 rounded">2</span>
                            </div>
                            <input type="range" id="col-range" min="1" max="6" value="2"
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>

                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm text-slate-700">Rows</label>
                                <span id="row-val"
                                    class="text-sm font-mono font-bold text-blue-600 bg-blue-50 px-2 rounded">2</span>
                            </div>
                            <input type="range" id="row-range" min="1" max="6" value="2"
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm text-slate-700">Padding</label>
                                <span id="gap-val"
                                    class="text-sm font-mono font-bold text-blue-600 bg-blue-50 px-2 rounded">10px</span>
                            </div>
                            <input type="range" id="gap-range" min="0" max="100" step="2" value="10"
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-sm text-slate-700">Image Fit</label>
                            <select id="fit-select"
                                class="w-full h-9 text-sm border border-slate-200 rounded-lg bg-white text-slate-700 outline-none focus:border-blue-500 px-2">
                                <option value="contain">Fit Frame (Contain)</option>
                                <option value="cover">Fill Frame (Cover)</option>
                                <option value="fill">Stretch (Fill)</option>
                                <option value="fit-tall">Fit Tall (Full Height)</option>
                                <option value="fit-wide">Fit Wide (Full Width)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 2. Symbol Appearance -->
                <div class="space-y-4 pt-2 border-t border-slate-100">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Symbol
                        Appearance</label>

                    <div class="grid grid-cols-1 gap-4">
                        <!-- Background Color -->
                        <div class="space-y-2">
                            <span class="text-sm text-slate-700 block">Background Color</span>
                            <div class="flex gap-3">
                                <button onclick="setBackground('#f8fafc', this)"
                                    class="color-btn w-8 h-8 rounded-full border border-slate-300 shadow-sm focus:outline-none selected"
                                    style="background-color: #f8fafc;" title="White"></button>
                                <button onclick="setBackground('#9ca3af', this)"
                                    class="color-btn w-8 h-8 rounded-full border border-slate-300 shadow-sm focus:outline-none"
                                    style="background-color: #9ca3af;" title="Grey"></button>
                                <button onclick="setBackground('#d4c5a0', this)"
                                    class="color-btn w-8 h-8 rounded-full border border-slate-300 shadow-sm focus:outline-none"
                                    style="background-color: #d4c5a0;" title="Beige"></button>
                                <button onclick="setBackground('#334155', this)"
                                    class="color-btn w-8 h-8 rounded-full border border-slate-300 shadow-sm focus:outline-none"
                                    style="background-color: #334155;" title="Dark Grey"></button>
                                <button onclick="setBackground('#000000', this)"
                                    class="color-btn w-8 h-8 rounded-full border border-slate-300 shadow-sm focus:outline-none"
                                    style="background-color: #000000;" title="Black"></button>
                            </div>
                        </div>

                        <!-- Borders -->
                        <!-- Border Color -->
                        <div class="space-y-2">
                            <span class="text-sm text-slate-700 block">Border Color</span>
                            <div class="flex justify-start gap-3">
                                <button onclick="setBorderColor('#000000', this)"
                                    class="border-color-btn w-8 h-8 rounded-full border border-slate-300 shadow-sm focus:outline-none selected"
                                    style="background-color: #000000;" title="Black"></button>
                                <button onclick="setBorderColor('#ffffff', this)"
                                    class="border-color-btn w-8 h-8 rounded-full border border-slate-300 shadow-sm focus:outline-none"
                                    style="background-color: #ffffff;" title="White"></button>
                                <button onclick="setBorderColor('#1e3a8a', this)"
                                    class="border-color-btn w-8 h-8 rounded-full border border-slate-300 shadow-sm focus:outline-none"
                                    style="background-color: #1e3a8a;" title="Blue"></button>
                                <button onclick="setBorderColor('#991b1b', this)"
                                    class="border-color-btn w-8 h-8 rounded-full border border-slate-300 shadow-sm focus:outline-none"
                                    style="background-color: #991b1b;" title="Red"></button>
                                <button onclick="setBorderColor('transparent', this)"
                                    class="border-color-btn w-8 h-8 rounded-full border border-slate-300 shadow-sm focus:outline-none flex items-center justify-center bg-slate-50"
                                    title="Transparent">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <!-- Border Width -->
                        <div class="space-y-2">
                            <div class="flex justify-between mb-1">
                                <label class="text-sm text-slate-600">Border Width</label>
                                <span id="border-width-val" class="text-xs font-bold text-blue-600">4px</span>
                            </div>
                            <input type="range" id="border-width-range" min="0" max="12" step="1" value="4"
                                class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                    </div>

                    <!-- Text Labels Block -->
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-sm font-semibold text-slate-700 block">Text Labels</span>
                                <span class="text-xs text-slate-500">Display names under symbols</span>
                            </div>
                            <div class="relative inline-block w-10 align-middle select-none">
                                <input type="checkbox" name="toggle" id="labels-toggle"
                                    class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" />
                                <label for="labels-toggle"
                                    class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <!-- Hidden Label Controls -->
                        <div id="label-size-control" class="hidden pt-2 border-t border-slate-200">
                            <div class="flex justify-between mb-1">
                                <label class="text-xs text-slate-600">Size</label>
                                <span id="label-size-val" class="text-xs font-bold text-blue-600">20px</span>
                            </div>
                            <input type="range" id="label-size-range" min="12" max="48" step="1" value="20"
                                class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>

                        <div id="label-color-control"
                            class="hidden pt-2 border-t border-slate-200 flex items-center justify-between">
                            <label class="text-xs text-slate-600">Color</label>
                            <div class="flex items-center gap-2">
                                <input id="label-color-picker" type="color" value="#000000"
                                    class="w-8 h-8 p-0 border border-slate-300 rounded-lg cursor-pointer" />
                                <select id="label-color-select"
                                    class="px-2 py-1 text-xs border border-slate-300 rounded-lg bg-white h-8">
                                    <option value="#000000" selected>Black</option>
                                    <option value="#ffffff">White</option>
                                    <option value="#1e3a8a">Navy</option>
                                    <option value="#b91c1c">Red</option>
                                    <option value="#16a34a">Green</option>
                                </select>
                            </div>
                        </div>

                        <div id="label-position-control"
                            class="hidden pt-2 border-t border-slate-200 flex items-center justify-between">
                            <label class="text-xs text-slate-600">Position</label>
                            <select id="label-position-select"
                                class="px-2 py-1 text-xs border border-slate-300 rounded-lg bg-white h-8">
                                <option value="below" selected>Below</option>
                                <option value="above">Above</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 3. Interaction & Audio -->
                <div class="space-y-4 pt-2 border-t border-slate-100">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Interaction &
                        Audio</label>

                    <!-- Audio Toggle -->
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 flex items-center justify-between">
                        <div>
                            <span class="text-sm font-semibold text-slate-700 block">Voice Output</span>
                            <span class="text-xs text-slate-500">Read names aloud</span>
                        </div>
                        <div class="relative inline-block w-10 align-middle select-none">
                            <input type="checkbox" name="toggle" id="audio-toggle"
                                class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" />
                            <label for="audio-toggle"
                                class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                        </div>
                    </div>

                    <!-- Magnifier -->
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-sm font-semibold text-slate-700 block">Touch Magnification</span>
                                <span class="text-xs text-amber-600 font-medium">(Play Mode Only)</span>
                            </div>
                            <div class="relative inline-block w-10 align-middle select-none">
                                <input type="checkbox" name="toggle" id="magnify-toggle"
                                    class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" />
                                <label for="magnify-toggle"
                                    class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div id="magnify-controls" class="pt-2 border-t border-slate-200 hidden">
                            <div class="flex justify-between mb-1">
                                <label class="text-xs text-slate-600">Zoom Level</label>
                                <span id="zoom-val" class="text-xs font-bold text-blue-600">1.35x</span>
                            </div>
                            <input type="range" id="zoom-range" min="1.2" max="2.5" step="0.05" value="1.35"
                                class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                    </div>

                    <!-- Timing Sliders -->
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-4">
                        <div>
                            <div class="flex justify-between mb-1">
                                <div>
                                    <span class="text-sm font-semibold text-slate-700 block">Dwell Time</span>
                                    <span class="text-xs text-slate-500">Hold to activate</span>
                                </div>
                                <span id="dwell-val" class="text-xs font-bold text-blue-600">Off</span>
                            </div>
                            <input type="range" id="dwell-range" min="0" max="0.5" step="0.1" value="0"
                                class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        <div class="pt-2 border-t border-slate-200">
                            <div class="flex justify-between mb-1">
                                <div>
                                    <span class="text-sm font-semibold text-slate-700 block">Cooldown</span>
                                    <span class="text-xs text-slate-500">Delay between taps</span>
                                </div>
                                <span id="cooldown-val" class="text-xs font-bold text-blue-600">Off</span>
                            </div>
                            <input type="range" id="cooldown-range" min="0" max="2.0" step="0.1" value="0"
                                class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                    </div>
                </div>

                <!-- 4. Games & Practice -->
                <div class="space-y-4 pt-2 border-t border-slate-100">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Games &
                        Practice</label>

                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-3">
                        <!-- Find-It Game -->
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-sm font-semibold text-slate-700 block">Find-It</span>
                                <span class="text-xs text-slate-500">Identify symbols</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="game-btn" onclick="toggleGame()"
                                    class="px-4 py-1.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white text-xs font-bold rounded-lg shadow-sm hover:from-blue-700 hover:to-blue-800 transition-all active:scale-95">
                                    Start
                                </button>
                                <button onclick="openPromptsModal()" title="Game Settings"
                                    class="p-1.5 bg-white border border-slate-200 text-slate-600 rounded hover:bg-slate-50 hover:text-blue-600 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path
                                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
                                        </path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Pop-Up Finder -->
                        <div class="flex items-center justify-between pt-2 border-t border-slate-200">
                            <div>
                                <span class="text-sm font-semibold text-slate-700 block">Pop-Up Finder</span>
                                <span class="text-xs text-slate-500">Tap to find</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="hunt-btn" onclick="toggleHuntGame()"
                                    class="px-4 py-1.5 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white text-xs font-bold rounded-lg shadow-sm hover:from-emerald-700 hover:to-emerald-800 transition-all active:scale-95">
                                    Start
                                </button>
                                <button onclick="openHuntPicker()" title="Choose picture"
                                    class="p-1.5 bg-white border border-slate-200 text-slate-500 rounded hover:bg-slate-50 hover:text-blue-600 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <path d="M21 15l-5-5L5 21"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Game Delay -->
                        <div class="pt-2 border-t border-slate-200">
                            <div class="flex justify-between mb-1">
                                <label class="text-xs text-slate-600">Game Speed (Delay)</label>
                                <span id="game-delay-val" class="text-xs font-bold text-blue-600">2s</span>
                            </div>
                            <input type="range" id="game-delay-range" min="1" max="4" step="0.5" value="2"
                                class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="pt-6 pb-4 text-center border-t border-slate-200/60 mt-4 bg-gradient-to-b from-transparent to-slate-50/50">
                <h3 class="text-sm font-semibold text-slate-700">By Niall Brown</h3>
                <p class="text-xs text-slate-500 font-medium mt-0.5">Early Childhood Vision Consultant</p>
                <p class="text-[10px] text-slate-400 mt-2">Version 1.0</p>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main id="main-content" class="h-screen w-full relative transition-colors duration-300"
        style="background-color: #f8fafc;">
        <div id="grid-container" class="hidden">
            <!-- Grid items injected here -->
        </div>

        <!-- Empty State (moved to grid cell) -->
    </main>

    <!-- Prompts Settings Modal -->
    <div id="prompts-modal" class="fixed inset-0 z-[100] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity" onclick="closePromptsModal()">
        </div>

        <!-- Modal Content -->
        <div
            class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center pointer-events-none">
            <div
                class="bg-white w-full md:w-[600px] md:rounded-2xl shadow-2xl flex flex-col max-h-[90vh] pointer-events-auto transform transition-transform duration-300 translate-y-full md:translate-y-0 md:shadow-xl md:shadow-slate-900/20">

                <!-- Header -->
                <div
                    class="flex items-center justify-between p-5 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-blue-50/30 md:rounded-t-2xl">
                    <h3 class="text-lg font-bold text-slate-800">Game Settings</h3>
                    <button onclick="closePromptsModal()"
                        class="p-2 hover:bg-slate-200/80 rounded-xl text-slate-500 hover:text-slate-700 transition-all active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto p-6 space-y-8">

                    <!-- General Settings -->
                    <div class="space-y-3">
                        <div>
                            <h4 class="font-bold text-slate-700">General Settings</h4>
                            <p class="text-sm text-slate-500">Configuration for game behavior.</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-semibold text-slate-700">Next Question Delay</label>
                                <span id="game-delay-val" class="text-sm font-mono font-bold text-blue-600">2s</span>
                            </div>
                            <input type="range" id="game-delay-range" min="1" max="4" step="0.5" value="2"
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                    </div>

                    <!-- Prompts (Question) -->
                    <div class="space-y-3">
                        <div>
                            <h4 class="font-bold text-slate-700">Prompts (Question)</h4>
                            <p class="text-sm text-slate-500">What the app says to ask for a symbol.</p>
                        </div>
                        <div class="space-y-3" id="prompts-inputs">
                            <!-- Inputs generated by JS -->
                        </div>
                    </div>

                    <!-- Incorrect Feedback -->
                    <div class="space-y-3">
                        <div>
                            <h4 class="font-bold text-slate-700">Incorrect Feedback</h4>
                            <p class="text-sm text-slate-500">What the app says when the wrong symbol is picked. Use
                                [word] for the symbol name.</p>
                        </div>
                        <div class="space-y-3" id="incorrect-inputs">
                            <!-- Inputs generated by JS -->
                        </div>
                    </div>

                    <!-- Correct Feedback -->
                    <div class="space-y-3">
                        <div>
                            <h4 class="font-bold text-slate-700">Correct Feedback</h4>
                            <p class="text-sm text-slate-500">What the app says when the correct symbol is picked.</p>
                        </div>
                        <div class="space-y-3" id="correct-inputs">
                            <!-- Inputs generated by JS -->
                        </div>
                    </div>

                </div>

                <!-- Footer -->
                <div
                    class="p-5 border-t border-slate-200 bg-gradient-to-b from-slate-50 to-slate-100/80 md:rounded-b-2xl">
                    <button onclick="savePromptsSettings()"
                        class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-blue-600/25 transition-all active:scale-[0.98] hover:shadow-xl">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Speech Label Modal -->
    <div id="speech-label-modal" class="fixed inset-0 z-[100] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"
            onclick="closeSpeechLabelModal()">
        </div>

        <!-- Modal Content -->
        <div
            class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center pointer-events-none">
            <div
                class="bg-white w-full md:w-[400px] md:rounded-2xl shadow-2xl flex flex-col max-h-[90vh] pointer-events-auto transform transition-transform duration-300 translate-y-full md:translate-y-0">

                <!-- Header -->
                <div class="flex items-center justify-between p-4 border-b border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800">Set Speech Label</h3>
                    <button onclick="closeSpeechLabelModal()"
                        class="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6 space-y-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">Default (Filename)</label>
                        <div id="speech-label-default" class="text-sm text-slate-500 bg-slate-50 p-2 rounded-lg"></div>
                    </div>
                    <div class="space-y-2">
                        <label for="speech-label-input" class="block text-sm font-semibold text-slate-700">Custom Speech
                            Label</label>
                        <input type="text" id="speech-label-input" placeholder="Type what should be spoken..."
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500 text-slate-700">
                        <p class="text-xs text-slate-500">Leave empty to use the filename.</p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-slate-100 bg-slate-50 md:rounded-b-2xl flex gap-3">
                    <button onclick="clearSpeechLabel()"
                        class="flex-1 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-xl transition-all active:scale-95">
                        Clear Label
                    </button>
                    <button onclick="saveSpeechLabel()"
                        class="flex-1 py-3 bg-violet-600 hover:bg-violet-700 text-white font-bold rounded-xl shadow-lg shadow-violet-600/20 transition-all active:scale-95">
                        Save Label
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Symbol Color Modal -->
    <div id="symbol-color-modal" class="fixed inset-0 z-[100] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"
            onclick="closeSymbolColorModal()">
        </div>

        <!-- Modal Content -->
        <div
            class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center pointer-events-none">
            <div
                class="bg-white w-full md:w-[400px] md:rounded-2xl shadow-2xl flex flex-col max-h-[90vh] pointer-events-auto transform transition-transform duration-300 translate-y-full md:translate-y-0">

                <!-- Header -->
                <div class="flex items-center justify-between p-4 border-b border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800">Symbol Colors</h3>
                    <button onclick="closeSymbolColorModal()"
                        class="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                    <!-- Background Color -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-semibold text-slate-700">Background Color</label>
                            <button onclick="clearSymbolBgColor()"
                                class="text-xs text-slate-500 hover:text-red-600 transition-colors">Clear</button>
                        </div>
                        <div id="symbol-bg-colors" class="grid grid-cols-5 gap-2">
                            <button onclick="setSymbolBgColor('#86efac')"
                                class="w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-slate-400 transition-colors"
                                style="background-color: #86efac;" title="Light Green"></button>
                            <button onclick="setSymbolBgColor('#fca5a5')"
                                class="w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-slate-400 transition-colors"
                                style="background-color: #fca5a5;" title="Red"></button>
                            <button onclick="setSymbolBgColor('#fbcfe8')"
                                class="w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-slate-400 transition-colors"
                                style="background-color: #fbcfe8;" title="Pink"></button>
                            <button onclick="setSymbolBgColor('#fef08a')"
                                class="w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-slate-400 transition-colors"
                                style="background-color: #fef08a;" title="Yellow"></button>
                            <button onclick="setSymbolBgColor('#fed7aa')"
                                class="w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-slate-400 transition-colors"
                                style="background-color: #fed7aa;" title="Orange"></button>
                            <button onclick="setSymbolBgColor('#93c5fd')"
                                class="w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-slate-400 transition-colors"
                                style="background-color: #93c5fd;" title="Blue"></button>
                            <button onclick="setSymbolBgColor('#c4b5fd')"
                                class="w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-slate-400 transition-colors"
                                style="background-color: #c4b5fd;" title="Purple"></button>
                            <button onclick="setSymbolBgColor('#d1d5db')"
                                class="w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-slate-400 transition-colors"
                                style="background-color: #d1d5db;" title="Grey"></button>
                            <button onclick="setSymbolBgColor('#1f2937')"
                                class="w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-slate-400 transition-colors"
                                style="background-color: #1f2937;" title="Black"></button>
                            <button onclick="setSymbolBgColor('#ffffff')"
                                class="w-10 h-10 rounded-lg border-2 border-slate-300 hover:border-slate-400 transition-colors"
                                style="background-color: #ffffff;" title="White"></button>
                        </div>
                        <div id="symbol-bg-preview" class="text-xs text-slate-500">Current: Default</div>
                    </div>

                    <!-- Border Color -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-semibold text-slate-700">Border Color</label>
                            <button onclick="clearSymbolBorderColor()"
                                class="text-xs text-slate-500 hover:text-red-600 transition-colors">Clear</button>
                        </div>
                        <div id="symbol-border-colors" class="grid grid-cols-5 gap-2">
                            <button onclick="setSymbolBorderColor('#22c55e')"
                                class="w-10 h-10 rounded-lg border-4 bg-white hover:scale-110 transition-transform"
                                style="border-color: #22c55e;" title="Green"></button>
                            <button onclick="setSymbolBorderColor('#ef4444')"
                                class="w-10 h-10 rounded-lg border-4 bg-white hover:scale-110 transition-transform"
                                style="border-color: #ef4444;" title="Red"></button>
                            <button onclick="setSymbolBorderColor('#ec4899')"
                                class="w-10 h-10 rounded-lg border-4 bg-white hover:scale-110 transition-transform"
                                style="border-color: #ec4899;" title="Pink"></button>
                            <button onclick="setSymbolBorderColor('#eab308')"
                                class="w-10 h-10 rounded-lg border-4 bg-white hover:scale-110 transition-transform"
                                style="border-color: #eab308;" title="Yellow"></button>
                            <button onclick="setSymbolBorderColor('#f97316')"
                                class="w-10 h-10 rounded-lg border-4 bg-white hover:scale-110 transition-transform"
                                style="border-color: #f97316;" title="Orange"></button>
                            <button onclick="setSymbolBorderColor('#3b82f6')"
                                class="w-10 h-10 rounded-lg border-4 bg-white hover:scale-110 transition-transform"
                                style="border-color: #3b82f6;" title="Blue"></button>
                            <button onclick="setSymbolBorderColor('#8b5cf6')"
                                class="w-10 h-10 rounded-lg border-4 bg-white hover:scale-110 transition-transform"
                                style="border-color: #8b5cf6;" title="Purple"></button>
                            <button onclick="setSymbolBorderColor('#6b7280')"
                                class="w-10 h-10 rounded-lg border-4 bg-white hover:scale-110 transition-transform"
                                style="border-color: #6b7280;" title="Grey"></button>
                            <button onclick="setSymbolBorderColor('#000000')"
                                class="w-10 h-10 rounded-lg border-4 bg-white hover:scale-110 transition-transform"
                                style="border-color: #000000;" title="Black"></button>
                            <button onclick="setSymbolBorderColor('#ffffff')"
                                class="w-10 h-10 rounded-lg border-4 bg-slate-100 hover:scale-110 transition-transform"
                                style="border-color: #ffffff;" title="White"></button>
                            <button onclick="setSymbolBorderColor('transparent')"
                                class="w-10 h-10 rounded-lg border-4 border-slate-200 bg-white hover:scale-110 transition-transform flex items-center justify-center"
                                title="Transparent">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                </svg>
                            </button>
                        </div>
                        <div id="symbol-border-preview" class="text-xs text-slate-500">Current: Default</div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-slate-100 bg-slate-50 md:rounded-b-2xl flex gap-3">
                    <button onclick="clearAllSymbolColors()"
                        class="flex-1 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-xl transition-all active:scale-95">
                        Clear All
                    </button>
                    <button onclick="closeSymbolColorModal()"
                        class="flex-1 py-3 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-xl shadow-lg shadow-amber-500/20 transition-all active:scale-95">
                        Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Label Modal (for text-only cells) -->
    <div id="text-label-modal" class="fixed inset-0 z-[100] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity"
            onclick="closeTextLabelModal()">
        </div>

        <!-- Modal Content -->
        <div
            class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center pointer-events-none">
            <div
                class="bg-white w-full md:w-[440px] md:rounded-2xl shadow-2xl flex flex-col max-h-[90vh] pointer-events-auto transform transition-transform duration-300 translate-y-full md:translate-y-0 md:shadow-xl md:shadow-slate-900/20">

                <!-- Header -->
                <div
                    class="flex items-center justify-between p-5 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-blue-50/30 md:rounded-t-2xl">
                    <h3 class="text-lg font-bold text-slate-800">Add Text Label</h3>
                    <button onclick="closeTextLabelModal()"
                        class="p-2 hover:bg-slate-200/80 rounded-xl text-slate-500 hover:text-slate-700 transition-all active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-5 space-y-5">

                    <!-- Section 1: Text Input -->
                    <div
                        class="bg-gradient-to-br from-slate-50 to-slate-100/50 rounded-xl p-4 space-y-3 border border-slate-200/60">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="text-blue-600">
                                    <polyline points="4 7 4 4 20 4 20 7"></polyline>
                                    <line x1="9" y1="20" x2="15" y2="20"></line>
                                    <line x1="12" y1="4" x2="12" y2="20"></line>
                                </svg>
                            </div>
                            <span class="text-sm font-bold text-slate-700">Text to Display</span>
                        </div>
                        <input type="text" id="text-label-input" placeholder="Enter word or phrase..."
                            class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-700 text-lg bg-white shadow-sm transition-all">
                        <p class="text-xs text-slate-500">This text will appear in the cell and be spoken when
                            activated.</p>
                    </div>

                    <!-- Section 2: Word Bubbling -->
                    <div
                        class="bg-gradient-to-br from-slate-50 to-slate-100/50 rounded-xl p-4 space-y-4 border border-slate-200/60 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="text-indigo-600">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                    </svg>
                                </div>
                                <div>
                                    <span class="text-sm font-bold text-slate-700">Word Bubbling</span>
                                    <p class="text-xs text-slate-500 font-medium">Dr. Christine Roman-Lanzy Method</p>
                                </div>
                            </div>
                            <div class="relative inline-block w-11 align-middle select-none">
                                <input type="checkbox" id="text-contour-toggle"
                                    class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" />
                                <label for="text-contour-toggle"
                                    class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <div id="contour-controls"
                            class="space-y-4 hidden transition-all duration-300 pt-3 border-t border-slate-200/50">
                            <!-- Bubble Color -->
                            <div class="space-y-3">
                                <span class="text-xs font-semibold text-slate-600 uppercase tracking-wide">Bubble
                                    Color</span>
                                <div class="flex gap-2.5">
                                    <button onclick="setTextContourColor('#ef4444', this)"
                                        class="contour-color-btn w-10 h-10 rounded-xl border-2 border-white shadow-md focus:outline-none ring-2 ring-offset-2 ring-transparent hover:scale-110 transition-all active:scale-95"
                                        style="background-color: #ef4444;" title="Red"></button>
                                    <button onclick="setTextContourColor('#eab308', this)"
                                        class="contour-color-btn w-10 h-10 rounded-xl border-2 border-white shadow-md focus:outline-none ring-2 ring-offset-2 ring-transparent hover:scale-110 transition-all active:scale-95"
                                        style="background-color: #eab308;" title="Yellow"></button>
                                    <button onclick="setTextContourColor('#22c55e', this)"
                                        class="contour-color-btn w-10 h-10 rounded-xl border-2 border-white shadow-md focus:outline-none ring-2 ring-offset-2 ring-transparent hover:scale-110 transition-all active:scale-95"
                                        style="background-color: #22c55e;" title="Green"></button>
                                    <button onclick="setTextContourColor('#3b82f6', this)"
                                        class="contour-color-btn w-10 h-10 rounded-xl border-2 border-white shadow-md focus:outline-none ring-2 ring-offset-2 ring-transparent hover:scale-110 transition-all active:scale-95"
                                        style="background-color: #3b82f6;" title="Blue"></button>
                                    <button onclick="setTextContourColor('#f97316', this)"
                                        class="contour-color-btn w-10 h-10 rounded-xl border-2 border-white shadow-md focus:outline-none ring-2 ring-offset-2 ring-transparent hover:scale-110 transition-all active:scale-95"
                                        style="background-color: #f97316;" title="Orange"></button>
                                </div>
                            </div>

                            <!-- Bubble Thickness -->
                            <div class="space-y-2 bg-white/70 rounded-xl p-3 border border-slate-200/60">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs font-semibold text-slate-600">Bubble Thickness</span>
                                    <span id="contour-width-val"
                                        class="text-xs font-bold text-blue-700 bg-blue-50 px-2.5 py-1 rounded-lg">8px</span>
                                </div>
                                <input type="range" id="contour-width-range" min="4" max="16" step="1" value="8"
                                    class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                            </div>

                            <!-- Gap Width -->
                            <div class="space-y-2 bg-white/70 rounded-xl p-3 border border-slate-200/60">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs font-semibold text-slate-600">Gap Width</span>
                                    <span id="contour-gap-val"
                                        class="text-xs font-bold text-blue-700 bg-blue-50 px-2.5 py-1 rounded-lg">4px</span>
                                </div>
                                <input type="range" id="contour-gap-range" min="0" max="12" step="1" value="4"
                                    class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Live Preview -->
                    <div class="space-y-3">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-md bg-slate-100 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="text-slate-500">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </div>
                            <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Live
                                Preview</span>
                        </div>
                        <div id="text-label-preview-container"
                            class="w-full h-32 bg-gradient-to-br from-white to-slate-50 border border-slate-200 rounded-xl flex items-center justify-center overflow-hidden shadow-inner">
                            <div id="text-label-preview" class="text-4xl font-extrabold text-center transition-all"
                                style="color: #000000; line-height: 1.1;">
                                Preview
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div
                    class="p-5 border-t border-slate-200 bg-gradient-to-b from-slate-50 to-slate-100/80 md:rounded-b-2xl flex gap-3">
                    <button onclick="closeTextLabelModal()"
                        class="flex-1 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-xl transition-all active:scale-[0.98]">
                        Cancel
                    </button>
                    <button onclick="saveTextLabel()"
                        class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-xl shadow-lg shadow-blue-600/25 transition-all active:scale-[0.98] hover:shadow-xl">
                        Add Label
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shapes Picker Modal -->
    <div id="shapes-modal" class="fixed inset-0 z-[100] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeShapesModal()">
        </div>

        <!-- Modal Content -->
        <div
            class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center pointer-events-none">
            <div
                class="bg-white w-full md:w-[560px] md:rounded-2xl shadow-2xl flex flex-col max-h-[90vh] pointer-events-auto transform transition-transform duration-300 translate-y-full md:translate-y-0">

                <!-- Header -->
                <div class="flex items-center justify-between p-4 border-b border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800">Add Symbol</h3>
                    <button onclick="closeShapesModal()"
                        class="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Tabs -->
                <div class="symbol-picker-tabs mx-4 mt-4">
                    <button id="tab-arasaac" class="symbol-picker-tab active" onclick="switchSymbolTab('arasaac')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                            <path d="M2 2l7.586 7.586"></path>
                            <circle cx="11" cy="11" r="2"></circle>
                        </svg>
                        <span class="flex flex-col items-start leading-tight">
                            <span class="font-semibold">ARASAAC</span>
                            <span class="text-xs opacity-70">Line Drawings</span>
                        </span>
                    </button>
                    <button id="tab-mulberry" class="symbol-picker-tab" onclick="switchSymbolTab('mulberry')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <span class="flex flex-col items-start leading-tight">
                            <span class="font-semibold">PiCom AI</span>
                            <span class="text-xs opacity-70">Photographs</span>
                        </span>
                    </button>
                </div>

                <!-- Tab Content: ARASAAC -->
                <div id="arasaac-tab-content" class="flex-1 overflow-y-auto p-4">
                    <!-- Search -->
                    <div class="arasaac-search-wrapper mb-4">
                        <svg class="arasaac-search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="arasaac-search-input" class="arasaac-search-input"
                            placeholder="Search ARASAAC line drawings..." autocomplete="off">
                    </div>

                    <!-- Popular Searches -->
                    <div class="mb-4">
                        <p class="text-xs text-slate-500 mb-2">Popular searches:</p>
                        <div class="arasaac-popular-symbols">
                            <button class="arasaac-popular-btn" onclick="searchArasaac('happy')">happy</button>
                            <button class="arasaac-popular-btn" onclick="searchArasaac('sad')">sad</button>
                            <button class="arasaac-popular-btn" onclick="searchArasaac('eat')">eat</button>
                            <button class="arasaac-popular-btn" onclick="searchArasaac('drink')">drink</button>
                            <button class="arasaac-popular-btn" onclick="searchArasaac('help')">help</button>
                            <button class="arasaac-popular-btn" onclick="searchArasaac('play')">play</button>
                            <button class="arasaac-popular-btn" onclick="searchArasaac('more')">more</button>
                            <button class="arasaac-popular-btn" onclick="searchArasaac('stop')">stop</button>
                            <button class="arasaac-popular-btn" onclick="searchArasaac('yes')">yes</button>
                            <button class="arasaac-popular-btn" onclick="searchArasaac('no')">no</button>
                        </div>
                    </div>

                    <!-- Results Grid -->
                    <div id="arasaac-results" class="arasaac-results-grid">
                        <div class="arasaac-empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <p class="font-medium">Search ARASAAC Line Drawings</p>
                            <p class="text-sm mt-1">Simple, clear pictogram symbols</p>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Mulberry -->
                <div id="mulberry-tab-content" class="flex-1 overflow-y-auto p-4 hidden">
                    <!-- Search -->
                    <div class="mulberry-search-wrapper mb-4">
                        <svg class="mulberry-search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="mulberry-search-input" class="mulberry-search-input"
                            placeholder="Search PiCom AI photographs..." autocomplete="off">
                    </div>

                    <!-- Popular Searches -->
                    <div class="mb-4">
                        <p class="text-xs text-slate-500 mb-2">Popular searches:</p>
                        <div class="mulberry-popular-symbols">
                            <button class="mulberry-popular-btn" onclick="searchMulberry('happy')">happy</button>
                            <button class="mulberry-popular-btn" onclick="searchMulberry('sad')">sad</button>
                            <button class="mulberry-popular-btn" onclick="searchMulberry('food')">food</button>
                            <button class="mulberry-popular-btn" onclick="searchMulberry('drink')">drink</button>
                            <button class="mulberry-popular-btn" onclick="searchMulberry('help')">help</button>
                            <button class="mulberry-popular-btn" onclick="searchMulberry('work')">work</button>
                            <button class="mulberry-popular-btn" onclick="searchMulberry('home')">home</button>
                            <button class="mulberry-popular-btn" onclick="searchMulberry('person')">person</button>
                            <button class="mulberry-popular-btn" onclick="searchMulberry('yes')">yes</button>
                            <button class="mulberry-popular-btn" onclick="searchMulberry('no')">no</button>
                        </div>
                    </div>

                    <!-- Results Grid -->
                    <div id="mulberry-results" class="mulberry-results-grid">
                        <div class="mulberry-empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <p class="font-medium">Search PiCom AI Photographs</p>
                            <p class="text-sm mt-1">Realistic AI-generated photo symbols</p>
                        </div>
                    </div>
                </div>

                <!-- Footer with Attribution -->
                <div class="p-4 border-t border-slate-100 bg-slate-50 md:rounded-b-2xl">
                    <div id="arasaac-attribution" class="arasaac-attribution mb-3">
                        Line drawings by <a href="https://arasaac.org" target="_blank" rel="noopener">ARASAAC</a>
                        (Sergio Palao / Gobierno de Aragn) 
                        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC
                            BY-NC-SA 4.0</a>
                    </div>
                    <div id="mulberry-attribution" class="mulberry-attribution mb-3 hidden">
                        Photographs by <a href="https://www.sensoryapphouse.com/" target="_blank" rel="noopener">PiCom
                            AI</a>
                        (Sensory App House / Global Symbols) 
                        <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">CC
                            BY-SA 4.0</a>
                    </div>
                    <button onclick="closeShapesModal()"
                        class="w-full py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-xl transition-all active:scale-95">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <script>
            // --- State Management ---
            let gridData = Array(4).fill(null);
            let config = {
                rows: 2,
                cols: 2,
                gap: 10,
                fit: 'contain',
                mode: 'edit',
                magnify: false,
                zoomLevel: 1.35,
                audioEnabled: false,
                borderColor: '#000000',
                borderWidth: 4,
                showLabels: false,
                labelColor: '#000000',
                labelSize: 20,
                labelPosition: 'below',
                dwellTime: 0,
                cooldownTime: 0,
                gameDelay: 2,
                // Custom TTS Prompts
                prompts: ["See if you can find", "Let's find", "Where is"],
                incorrectFeedback: ["That's [word], let's find", "That's [word], see if you can find", ""],
                correctFeedback: ["You found", "", ""]
            };

            // Timing state
            let dwellTimer = null;
            let lastActivationTime = 0;

            // Game state
            let gameActive = false;
            let currentTargetIndex = null;

            // --- Pop-Up Finder Game State ---
            let huntActive = false;
            let huntSelected = null; // {src, label, fromIndex: number|null }
            let huntCurrentIndex = null;
            let huntRestore = null;  // {fromIndex, item} for restoring original symbol on stop
            let huntPendingChoice = null;
            // gamePhrases and reinforcementPhrases are now derived from config

            // --- Persistence (IndexedDB + localStorage) ---
            const DB_NAME = 'ACC_Sandbox_DB';
            const DB_VERSION = 1;
            const STORE_NAME = 'grid_store';
            const KEY_GRID = 'grid_data';
            const STORAGE_KEY_CONFIG = 'acc_sandbox_config';

            // Helper: Convert File to Base64
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            // Initialize DB
            function openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = event => reject('DB Error: ' + event.target.error);
                    request.onupgradeneeded = event => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME);
                        }
                    };
                    request.onsuccess = event => resolve(event.target.result);
                });
            }

            async function saveToLocalStorage() {
                try {
                    // Save config to localStorage (lightweight)
                    const configToSave = { ...config };
                    localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(configToSave));

                    // Save gridData to IndexedDB (heavy updates)
                    const db = await openDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.put(gridData, KEY_GRID);
                } catch (e) {
                    console.warn('Persistence Error:', e);
                }
            }

            async function loadFromLocalStorage() {
                try {
                    // Load config
                    const savedConfig = localStorage.getItem(STORAGE_KEY_CONFIG);
                    if (savedConfig) {
                        const parsed = JSON.parse(savedConfig);
                        if (typeof parsed === 'object' && parsed !== null) {
                            Object.assign(config, parsed);

                            // FORCE Edit Mode on startup
                            config.mode = 'edit';

                            // Sync UI controls with loaded config
                            syncUIFromConfig();

                            // Apply mode visuals & ensure drawer is open
                            setMode('edit');
                            toggleDrawer(true);
                        }
                    }

                    // Load gridData
                    const db = await openDB();
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(KEY_GRID);

                    request.onsuccess = () => {
                        if (request.result && Array.isArray(request.result)) {
                            gridData = request.result;
                            renderGrid(); // Re-render after loading data
                        }
                    };
                } catch (e) {
                    console.warn('Load Error:', e);
                }
            }

            async function clearLocalStorage() {
                try {
                    localStorage.removeItem(STORAGE_KEY_CONFIG);
                    const db = await openDB();
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.delete(KEY_GRID);
                } catch (e) {
                    console.warn('Clear Error:', e);
                }
            }

            // Helper to sync UI elements with config state
            function syncUIFromConfig() {
                if (colRange) colRange.value = config.cols;
                if (rowRange) rowRange.value = config.rows;
                if (gapRange) gapRange.value = config.gap;
                if (fitSelect) fitSelect.value = config.fit;
                if (magnifyToggle) magnifyToggle.checked = config.magnify;
                if (zoomRange) zoomRange.value = config.zoomLevel;
                if (audioToggle) audioToggle.checked = config.audioEnabled;
                if (borderWidthRange) borderWidthRange.value = config.borderWidth;
                if (labelSizeRange) labelSizeRange.value = config.labelSize;
                if (gameDelayRange) gameDelayRange.value = config.gameDelay;
                if (dwellRange) dwellRange.value = config.dwellTime;
                if (cooldownRange) cooldownRange.value = config.cooldownTime;

                // Sync label settings
                if (labelPositionSelect) labelPositionSelect.value = config.labelPosition || 'below';
                if (labelColorSelect) labelColorSelect.value = config.labelColor || '#000000';
                if (labelColorPicker) labelColorPicker.value = config.labelColor || '#000000';

                // Update display labels
                if (colVal) colVal.innerText = config.cols;
                if (rowVal) rowVal.innerText = config.rows;
                if (gapVal) gapVal.innerText = `${config.gap}px`;
                if (zoomVal) zoomVal.innerText = config.zoomLevel + 'x';
                if (borderWidthVal) borderWidthVal.innerText = config.borderWidth === 0 ? 'None' : `${config.borderWidth}px`;
                if (labelSizeVal) labelSizeVal.innerText = `${config.labelSize}px`;
                if (dwellVal) dwellVal.innerText = config.dwellTime === 0 ? 'Off' : `${config.dwellTime}s`;
                if (cooldownVal) cooldownVal.innerText = config.cooldownTime === 0 ? 'Off' : `${config.cooldownTime}s`;
                if (gameDelayVal) gameDelayVal.innerText = `${config.gameDelay}s`;
            }

            // --- DOM Elements ---
            const drawer = document.getElementById('drawer');
            const mainContent = document.getElementById('main-content');
            const openBtn = document.getElementById('open-btn');
            const closeBtn = document.getElementById('close-btn');
            const fileInput = document.getElementById('file-input');
            const gridContainer = document.getElementById('grid-container');
            const emptyState = document.getElementById('empty-state');
            const fileStatus = document.getElementById('file-status');
            const fileCountSpan = document.getElementById('file-count');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const loadingOverlay = document.getElementById('loading-overlay');

            // Inputs
            const colRange = document.getElementById('col-range');
            const rowRange = document.getElementById('row-range');
            const gapRange = document.getElementById('gap-range');
            const colVal = document.getElementById('col-val');
            const rowVal = document.getElementById('row-val');
            const gapVal = document.getElementById('gap-val');
            const fitSelect = document.getElementById('fit-select');

            // Feature Controls
            const magnifyToggle = document.getElementById('magnify-toggle');
            const magnifyControls = document.getElementById('magnify-controls');
            const zoomRange = document.getElementById('zoom-range');
            const zoomVal = document.getElementById('zoom-val');
            const audioToggle = document.getElementById('audio-toggle');
            const borderWidthRange = document.getElementById('border-width-range');
            const borderWidthVal = document.getElementById('border-width-val');
            const labelsToggle = document.getElementById('labels-toggle');
            const labelSizeControl = document.getElementById('label-size-control');
            const labelSizeRange = document.getElementById('label-size-range');
            const labelSizeVal = document.getElementById('label-size-val');
            const labelColorControl = document.getElementById('label-color-control');
            const labelColorSelect = document.getElementById('label-color-select');
            const labelColorPicker = document.getElementById('label-color-picker');
            const dwellRange = document.getElementById('dwell-range');
            const dwellVal = document.getElementById('dwell-val');
            const cooldownRange = document.getElementById('cooldown-range');
            const cooldownVal = document.getElementById('cooldown-val');
            const gameBtn = document.getElementById('game-btn');
            const gameDelayRange = document.getElementById('game-delay-range');
            const gameDelayVal = document.getElementById('game-delay-val');

            // Mode Buttons
            const btnEdit = document.getElementById('btn-mode-edit');
            const btnPlay = document.getElementById('btn-mode-play');
            const sectionUpload = document.getElementById('section-upload');
            const sectionDimensions = document.getElementById('section-dimensions');

            // --- Global Error Handler (Failsafe) ---
            window.onerror = function () {
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
            };

            // --- Loading Fail-Safe ---
            loadingOverlay.addEventListener('click', () => {
                loadingOverlay.classList.add('hidden');
            });

            // --- TTS Helper ---
            let availableVoices = [];
            window.speechSynthesis.onvoiceschanged = () => {
                availableVoices = window.speechSynthesis.getVoices();
            };
            availableVoices = window.speechSynthesis.getVoices();

            // Global array to prevent garbage collection of utterances
            const activeUtterances = [];
            let speechTimeout = null;

            function speak(text, force = true) {
                if (!config.audioEnabled || !text) return;

                // If forcing, clear any pending speech that hasn't started yet
                if (force && speechTimeout) {
                    clearTimeout(speechTimeout);
                    speechTimeout = null;
                }

                // Cancel current audio immediately if forcing
                if (force) {
                    window.speechSynthesis.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);

                // Robust voice selection logic
                if (availableVoices.length === 0) {
                    availableVoices = window.speechSynthesis.getVoices();
                }

                // If still empty, it might load async later, but we proceed with default for now.
                // Try to pick a preferred voice if available
                if (availableVoices.length > 0) {
                    let selectedVoice = availableVoices.find(v => v.name.includes('Google US English')) ||
                        availableVoices.find(v => v.name.includes('Samantha')) ||
                        availableVoices.find(v => v.lang.startsWith('en') && v.localService);

                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                }

                utterance.rate = 1.0;

                // Delay speaking slightly to ensure browser is ready and allow for precise cancellation
                speechTimeout = setTimeout(() => {
                    // Keep reference to prevent garbage collection
                    activeUtterances.push(utterance);

                    utterance.onend = () => {
                        const index = activeUtterances.indexOf(utterance);
                        if (index > -1) activeUtterances.splice(index, 1);
                    };

                    utterance.onerror = (e) => {
                        // Ignore expected interruptions (e.g., when tapping quickly)
                        if (e.error !== 'interrupted' && e.error !== 'canceled') {
                            console.warn('Speech error:', e);
                        }
                        const index = activeUtterances.indexOf(utterance);
                        if (index > -1) activeUtterances.splice(index, 1);
                    };

                    window.speechSynthesis.speak(utterance);
                    speechTimeout = null;
                }, 10);
            }

            // --- TTS Format Logic: Stop at first dash ---
            function formatLabel(filename) {
                let name = filename.replace(/\.[^/.]+$/, ""); // Remove extension
                if (name.includes('-')) {
                    name = name.split('-')[0]; // Take part before first dash
                }
                // Clean up underscores and extra spaces
                name = name.replace(/_/g, " ");
                name = name.replace(/\s+/g, " ").trim();
                return name;
            }

            // --- Clean Up ---
            function clearAllGhosts() {
                if (touchGhost && touchGhost.parentNode) {
                    touchGhost.parentNode.removeChild(touchGhost);
                }
                touchGhost = null;
                touchDragItem = null;
                touchDragIndex = null;

                if (currentMagnifiedEl) {
                    currentMagnifiedEl.classList.remove('magnified');
                    currentMagnifiedEl.style.transform = 'scale(1)';
                    currentMagnifiedEl = null;
                }
                document.querySelectorAll('.magnified').forEach(el => {
                    el.classList.remove('magnified');
                    el.style.transform = 'scale(1)';
                });
                document.querySelectorAll('.grid-cell').forEach(el => {
                    el.classList.remove('drag-over', 'dragging');
                });
            }

            // --- Sync Config ---


            function syncConfig() {
                config.cols = parseInt(colRange.value);
                config.rows = parseInt(rowRange.value);
                config.gap = parseInt(gapRange.value);
                config.fit = fitSelect.value;
                config.magnify = magnifyToggle.checked;
                config.zoomLevel = parseFloat(zoomRange.value);
                config.audioEnabled = audioToggle.checked;
                config.borderWidth = parseInt(borderWidthRange.value);
                config.labelSize = parseInt(labelSizeRange.value);
                config.gameDelay = parseFloat(gameDelayRange.value);
                // Label settings are usually event-driven but sync here for completeness
                if (labelPositionSelect) config.labelPosition = labelPositionSelect.value;

                colVal.innerText = config.cols;
                rowVal.innerText = config.rows;
                gapVal.innerText = `${config.gap}px`;
                zoomVal.innerText = config.zoomLevel + 'x';
                borderWidthVal.innerText = config.borderWidth === 0 ? 'None' : `${config.borderWidth}px`;
                labelSizeVal.innerText = `${config.labelSize}px`;

                updatePresetHighlight();
                saveToLocalStorage(); // Persist changes
            }

            // --- Safe Unlock Logic ---
            let unlockTimer = null;
            const unlockDuration = 1500;

            function startUnlock(e) {
                if (config.mode !== 'play') return;
                if (e.type === 'touchstart') e.preventDefault();
                openBtn.classList.add('unlocking');
                unlockTimer = setTimeout(() => {
                    setMode('edit');
                    toggleDrawer(true);
                    endUnlock();
                }, unlockDuration);
            }

            function endUnlock() {
                if (unlockTimer) {
                    clearTimeout(unlockTimer);
                    unlockTimer = null;
                }
                openBtn.classList.remove('unlocking');
            }

            openBtn.addEventListener('mousedown', startUnlock);
            openBtn.addEventListener('touchstart', startUnlock);
            openBtn.addEventListener('mouseup', endUnlock);
            openBtn.addEventListener('mouseleave', endUnlock);
            openBtn.addEventListener('touchend', endUnlock);

            openBtn.addEventListener('click', (e) => {
                if (config.mode === 'edit') {
                    toggleDrawer(true);
                } else {
                    e.preventDefault();
                }
            });

            // --- Resize Logic ---
            function resizeGrid(newRows, newCols) {
                const newSize = newRows * newCols;

                // If growing, pad with nulls
                if (newSize > gridData.length) {
                    const extraNeeded = newSize - gridData.length;
                    for (let i = 0; i < extraNeeded; i++) {
                        gridData.push(null);
                    }
                }

                // If shrinking, we DO NOT remove data. We just update the view dimensions.
                // This preserves items that fall out of view so they reappear when expanding.

                config.rows = newRows;
                config.cols = newCols;
            }

            // --- Mode Logic ---
            window.setMode = function (mode) {
                clearAllGhosts();
                syncConfig();

                config.mode = mode;
                const isEdit = mode === 'edit';

                if (isEdit) {
                    btnEdit.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                    btnEdit.classList.remove('text-slate-500', 'hover:text-slate-700');
                    btnPlay.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                    btnPlay.classList.add('text-slate-500', 'hover:text-slate-700');

                    sectionUpload.style.opacity = '1';
                    sectionUpload.style.pointerEvents = 'auto';
                    sectionDimensions.style.opacity = '1';
                    sectionDimensions.style.pointerEvents = 'auto';

                    mainContent.classList.remove('play-mode');
                } else {
                    btnPlay.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                    btnPlay.classList.remove('text-slate-500', 'hover:text-slate-700');
                    btnEdit.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                    btnEdit.classList.add('text-slate-500', 'hover:text-slate-700');

                    sectionUpload.style.opacity = '0.4';
                    sectionUpload.style.pointerEvents = 'none';
                    sectionDimensions.style.opacity = '0.4';
                    sectionDimensions.style.pointerEvents = 'none';

                    mainContent.classList.add('play-mode');
                    toggleDrawer(false);
                }
                renderGrid();
            };

            window.setBackground = function (color, btnElement) {
                mainContent.style.backgroundColor = color;
                document.body.style.backgroundColor = color;

                const isDark = (color === '#334155' || color === '#000000');
                const emptyText = document.querySelectorAll('#empty-state p, #empty-state svg');
                emptyText.forEach(el => {
                    el.style.color = isDark ? '#475569' : (el.tagName === 'svg' ? '#cbd5e1' : '#94a3b8');
                });

                document.querySelectorAll('.color-btn').forEach(btn => {
                    btn.classList.remove('selected', 'ring-2', 'ring-blue-500', 'scale-110');
                    btn.style.transform = 'scale(1)';
                });
                if (btnElement) {
                    btnElement.classList.add('selected', 'ring-2', 'ring-blue-500');
                    btnElement.style.transform = 'scale(1.1)';
                }
            };

            window.setBorderColor = function (color, btnElement) {
                config.borderColor = color;

                document.querySelectorAll('.border-color-btn').forEach(btn => {
                    btn.classList.remove('selected', 'ring-2', 'ring-blue-500', 'scale-110');
                    btn.style.transform = 'scale(1)';
                });
                if (btnElement) {
                    btnElement.classList.add('selected', 'ring-2', 'ring-blue-500');
                    btnElement.style.transform = 'scale(1.1)';
                }

                renderGrid();
            };

            function toggleDrawer(isOpen) {
                if (isOpen) {
                    drawer.classList.remove('drawer-closed');
                    drawer.classList.add('drawer-open');
                    openBtn.classList.add('hidden');
                } else {
                    drawer.classList.remove('drawer-open');
                    drawer.classList.add('drawer-closed');
                    openBtn.classList.remove('hidden');
                }
            }

            closeBtn.addEventListener('click', () => {
                toggleDrawer(false);
                loadingOverlay.classList.add('hidden');
            });

            // --- Feature Listeners ---
            function updateFeatures() {
                config.magnify = magnifyToggle.checked;
                config.zoomLevel = parseFloat(zoomRange.value);
                config.audioEnabled = audioToggle.checked;
                zoomVal.innerText = config.zoomLevel + 'x';
                if (config.magnify) {
                    magnifyControls.classList.remove('hidden');
                } else {
                    magnifyControls.classList.add('hidden');
                }
            }

            magnifyToggle.addEventListener('change', updateFeatures);
            zoomRange.addEventListener('input', updateFeatures);
            audioToggle.addEventListener('change', updateFeatures);

            // Border width listener
            borderWidthRange.addEventListener('input', () => {
                config.borderWidth = parseInt(borderWidthRange.value);
                borderWidthVal.innerText = config.borderWidth === 0 ? 'None' : `${config.borderWidth}px`;
                renderGrid();
            });

            // Image Fit Select Listener
            const fitSelectEl = document.getElementById('fit-select');
            if (fitSelectEl) {
                fitSelectEl.addEventListener('change', () => {
                    config.fit = fitSelectEl.value;
                    renderGrid();
                });
                // Initialize value
                fitSelectEl.value = config.fit || 'contain';
            }

            // Labels toggle listener
            const labelPositionControl = document.getElementById('label-position-control');
            const labelPositionSelect = document.getElementById('label-position-select');

            labelsToggle.addEventListener('change', () => {
                config.showLabels = labelsToggle.checked;
                if (config.showLabels) {
                    // Default to black when enabling text (unless already set)
                    if (!config.labelColor) config.labelColor = '#000000';
                    labelSizeControl.classList.remove('hidden');
                    labelColorControl.classList.remove('hidden');
                    labelPositionControl.classList.remove('hidden');
                    labelColorSelect.value = config.labelColor;
                    labelColorPicker.value = config.labelColor;
                    labelPositionSelect.value = config.labelPosition || 'below';
                } else {
                    labelSizeControl.classList.add('hidden');
                    labelColorControl.classList.add('hidden');
                    labelPositionControl.classList.add('hidden');
                }
                renderGrid();
            });

            // Label position listener
            labelPositionSelect.addEventListener('change', () => {
                config.labelPosition = labelPositionSelect.value;
                renderGrid();
            });


            // Label size listener
            labelSizeRange.addEventListener('input', () => {
                config.labelSize = parseInt(labelSizeRange.value);
                labelSizeVal.innerText = `${config.labelSize}px`;
                // Update existing labels directly for performance
                document.querySelectorAll('.label-text').forEach(el => {
                    el.style.fontSize = `${config.labelSize}px`;
                });

            });

            // Label color listeners
            function setLabelColor(hex) {
                config.labelColor = hex;
                if (labelColorSelect.value !== hex) {
                    // Check if matching option exists, else custom
                    // Simple logic: just set select value, if invalid (custom) it usually stays on previous or empty
                    // But better to just try setting it.
                    labelColorSelect.value = hex;
                }
                if (labelColorPicker.value !== hex) labelColorPicker.value = hex;
                renderGrid();
            }

            labelColorSelect.addEventListener('change', () => {
                setLabelColor(labelColorSelect.value);
            });

            labelColorPicker.addEventListener('input', () => {
                setLabelColor(labelColorPicker.value);
            });

            // Dwell time listener
            dwellRange.addEventListener('input', () => {
                config.dwellTime = parseFloat(dwellRange.value);
                dwellVal.innerText = config.dwellTime === 0 ? 'Off' : `${config.dwellTime}s`;
            });

            // Cooldown time listener
            cooldownRange.addEventListener('input', () => {
                config.cooldownTime = parseFloat(cooldownRange.value);
                cooldownVal.innerText = config.cooldownTime === 0 ? 'Off' : `${config.cooldownTime}s`;
            });

            // Game toggle logic
            window.toggleGame = function () {
                if (gameActive) {
                    stopGame();
                } else {
                    startGame();
                }
            };

            // Game delay listener
            gameDelayRange.addEventListener('input', () => {
                config.gameDelay = parseFloat(gameDelayRange.value);
                gameDelayVal.innerText = `${config.gameDelay}s`;
            });

            // --- Magnify Interaction (Pointer Events - immediate on first press) ---
            // Pointer events unify mouse/touch/stylus and ensure the VERY FIRST press magnifies (no movement required).
            let currentMagnifiedEl = null;
            let magnifyPointerId = null;

            function updateMagnifyAtPoint(clientX, clientY) {
                const target = document.elementFromPoint(clientX, clientY);
                const gridCell = target ? target.closest('.grid-cell.occupied') : null;

                // Optimize and prevent repeated speech
                if (currentMagnifiedEl === gridCell) return;

                if (currentMagnifiedEl && currentMagnifiedEl !== gridCell) {
                    currentMagnifiedEl.classList.remove('magnified');
                    currentMagnifiedEl.style.removeProperty('--zoom-level');
                    currentMagnifiedEl = null;
                }

                if (gridCell) {
                    currentMagnifiedEl = gridCell;
                    currentMagnifiedEl.classList.add('magnified');
                    currentMagnifiedEl.style.setProperty('--zoom-level', String(config.zoomLevel));
                }
            }

            function handleMagnifyEnd(e) {
                const isRelease = e && (e.type === 'touchend' || e.type === 'mouseup' || e.type === 'pointerup');

                if (currentMagnifiedEl) {
                    // Store reference before clearing magnified state
                    const cellElement = currentMagnifiedEl;
                    const index = cellElement.dataset.index;

                    // Clear magnified visual first
                    cellElement.classList.remove('magnified');
                    cellElement.style.removeProperty('--zoom-level');
                    currentMagnifiedEl = null;

                    if (isRelease && config.magnify && config.mode === 'play') {
                        if (gridData[index]) {
                            if (huntActive) {
                                handleHuntPress(parseInt(index), cellElement);
                            } else if (gameActive) {
                                // Apply pop animation to the cell directly for game mode
                                cellElement.classList.add('game-pop', 'ring-4', 'ring-green-500');
                                setTimeout(() => {
                                    cellElement.classList.remove('game-pop', 'ring-4', 'ring-green-500');
                                }, 550);
                                checkAnswer(parseInt(index));
                            } else {
                                if (config.audioEnabled) {
                                    speak(getSpeechLabel(gridData[index]));
                                } else {
                                    playChime();
                                }
                            }
                        }
                    }
                }
            }

            function handleMagnifyPointerDown(e) {
                if (config.mode !== 'play' || !config.magnify) return;

                // Only left mouse button; touch/stylus are OK
                if (e.pointerType === 'mouse' && e.button !== 0) return;

                // Prevent scroll/selection while magnifying
                if (e.cancelable) e.preventDefault();

                magnifyPointerId = e.pointerId;

                // Capture on the grid container so moves/up still fire while holding
                try { gridContainer.setPointerCapture(magnifyPointerId); } catch (_) { }

                // IMPORTANT: magnify immediately on first press
                updateMagnifyAtPoint(e.clientX, e.clientY);
            }

            function handleMagnifyPointerMove(e) {
                if (config.mode !== 'play' || !config.magnify) return;
                if (magnifyPointerId === null || e.pointerId !== magnifyPointerId) return;

                // For mouse, only magnify while button is held
                if (e.pointerType === 'mouse' && (e.buttons & 1) === 0) return;

                if (e.cancelable) e.preventDefault();
                updateMagnifyAtPoint(e.clientX, e.clientY);
            }

            function handleMagnifyPointerUp(e) {
                if (magnifyPointerId === null || e.pointerId !== magnifyPointerId) return;

                try { gridContainer.releasePointerCapture(magnifyPointerId); } catch (_) { }
                magnifyPointerId = null;

                // Trigger the same release behavior (speech / game check)
                handleMagnifyEnd({ type: 'pointerup' });
            }

            function handleMagnifyPointerCancel(e) {
                if (magnifyPointerId === null || e.pointerId !== magnifyPointerId) return;

                try { gridContainer.releasePointerCapture(magnifyPointerId); } catch (_) { }
                magnifyPointerId = null;

                // Cleanup only; no speech/check on cancel
                handleMagnifyEnd({ type: 'pointercancel' });
            }

            // Attach to the grid only so drawer hold-to-unlock still works.
            gridContainer.addEventListener('pointerdown', handleMagnifyPointerDown, { passive: false });
            gridContainer.addEventListener('pointermove', handleMagnifyPointerMove, { passive: false });
            gridContainer.addEventListener('pointerup', handleMagnifyPointerUp);
            gridContainer.addEventListener('pointercancel', handleMagnifyPointerCancel);

            // --- Drag and Drop Logic (Edit Mode) ---
            let dragSrcIndex = null;

            function handleDragStart(e) {
                if (config.mode !== 'edit') { e.preventDefault(); return false; }

                this.classList.add('dragging');
                dragSrcIndex = Number(this.dataset.index);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', dragSrcIndex);
            }

            function handleDragOver(e) {
                if (config.mode !== 'edit') return;
                if (e.preventDefault) e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                return false;
            }

            function handleDragEnter(e) {
                if (config.mode !== 'edit') return;
                this.classList.add('drag-over');
            }

            function handleDragLeave(e) {
                this.classList.remove('drag-over');
            }

            function handleDrop(e) {
                if (config.mode !== 'edit') return;
                e.stopPropagation();
                let dragDestIndex = Number(this.dataset.index);
                if (dragSrcIndex !== dragDestIndex) {
                    const srcContent = gridData[dragSrcIndex];
                    const destContent = gridData[dragDestIndex];
                    gridData[dragDestIndex] = srcContent;
                    gridData[dragSrcIndex] = destContent;
                    renderGrid();
                }
                return false;
            }

            function handleDragEnd(e) {
                document.querySelectorAll('.grid-cell').forEach(item => {
                    item.classList.remove('drag-over');
                    item.classList.remove('dragging');
                });
            }

            // --- Mobile Touch Drag Logic (Edit Mode) ---
            let touchDragItem = null;
            let touchDragIndex = null;
            let touchGhost = null;

            function handleEditTouchStart(e) {
                if (config.mode !== 'edit') return;
                if (!this.classList.contains('occupied')) return;
                if (e.target.closest('.delete-btn')) return;
                if (e.target.closest('.preview-btn')) return; // Ignore if preview clicked
                if (e.target.closest('.label-btn')) return; // Ignore if speech label button clicked
                if (e.target.closest('.color-pick-btn')) return; // Ignore if color button clicked
                if (e.touches.length > 1) return;

                touchDragItem = this;
                touchDragIndex = parseInt(this.dataset.index);

                // Create drag ghost - handle image, shape, or text-only cells
                const img = this.querySelector('img');
                const shapeSymbol = this.querySelector('.shape-symbol');
                const textLabel = this.querySelector('.text-only-label');

                if (img) {
                    touchGhost = img.cloneNode(true);
                } else if (shapeSymbol) {
                    touchGhost = document.createElement('div');
                    touchGhost.textContent = shapeSymbol.textContent;
                    touchGhost.style.fontSize = '3rem';
                    touchGhost.style.display = 'flex';
                    touchGhost.style.alignItems = 'center';
                    touchGhost.style.justifyContent = 'center';
                    touchGhost.style.background = 'white';
                    touchGhost.style.borderRadius = '8px';
                } else if (textLabel) {
                    touchGhost = document.createElement('div');
                    touchGhost.textContent = textLabel.textContent;
                    touchGhost.style.fontSize = '1.5rem';
                    touchGhost.style.fontWeight = 'bold';
                    touchGhost.style.display = 'flex';
                    touchGhost.style.alignItems = 'center';
                    touchGhost.style.justifyContent = 'center';
                    touchGhost.style.background = 'white';
                    touchGhost.style.borderRadius = '8px';
                    touchGhost.style.padding = '8px';
                } else {
                    // Fallback: clone entire cell content
                    touchGhost = this.cloneNode(true);
                }

                touchGhost.style.position = 'fixed';
                touchGhost.style.width = `${this.offsetWidth}px`;
                touchGhost.style.height = `${this.offsetHeight}px`;
                const touch = e.touches[0];
                touchGhost.style.left = `${touch.clientX - (this.offsetWidth / 2)}px`;
                touchGhost.style.top = `${touch.clientY - (this.offsetHeight / 2)}px`;
                touchGhost.style.opacity = '0.8';
                touchGhost.style.zIndex = '9999';
                touchGhost.style.pointerEvents = 'none';
                touchGhost.style.transform = 'scale(1.05)';
                touchGhost.style.boxShadow = '0 10px 20px rgba(0,0,0,0.3)';

                document.body.appendChild(touchGhost);
                this.style.opacity = '0.4';
            }

            let isTouchMovePending = false;

            function handleEditTouchMove(e) {
                if (!touchGhost || config.mode !== 'edit') return;
                e.preventDefault();

                if (!isTouchMovePending) {
                    isTouchMovePending = true;
                    requestAnimationFrame(() => {
                        const touch = e.touches[0];
                        touchGhost.style.left = `${touch.clientX - (touchGhost.offsetWidth / 2)}px`;
                        touchGhost.style.top = `${touch.clientY - (touchGhost.offsetHeight / 2)}px`;

                        document.querySelectorAll('.grid-cell').forEach(el => el.classList.remove('drag-over'));
                        const target = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetItem = target?.closest('.grid-cell');
                        if (targetItem && targetItem !== touchDragItem) {
                            targetItem.classList.add('drag-over');
                        }
                        isTouchMovePending = false;
                    });
                }
            }

            function handleEditTouchEnd(e) {
                if (!touchGhost || config.mode !== 'edit') return;

                const touch = e.changedTouches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                const targetItem = target?.closest('.grid-cell');

                if (targetItem) {
                    const targetIndex = parseInt(targetItem.dataset.index);
                    if (targetIndex !== touchDragIndex && !isNaN(targetIndex)) {
                        const srcContent = gridData[touchDragIndex];
                        const destContent = gridData[targetIndex];
                        gridData[targetIndex] = srcContent;
                        gridData[touchDragIndex] = destContent;
                        renderGrid();
                    }
                }
                clearAllGhosts();
            }

            // --- Audio Chime Generator ---
            function playChime() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800; // Pleasant chime frequency
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
            // Simple confirmation beep (used by Pop-Up Finder when voice is OFF)
            // Uses the same WebAudio path as playChime, but shorter.
            function playBeep() {
                // Reuse playChime if present; keep as its own function so callers never break.
                try {
                    // Ensure we have a user-gesture-started AudioContext; playChime already does that safely.
                    playChime();
                } catch (e) {
                    // no-op
                }
            }



            // --- Pop-Up Finder Game Logic ---
            const huntBtn = document.getElementById('hunt-btn');
            const huntModal = document.getElementById('hunt-modal');
            const huntPickerGrid = document.getElementById('hunt-picker-grid');
            const huntConfirmBtn = document.getElementById('hunt-confirm-btn');
            const huntPickerHint = document.getElementById('hunt-picker-hint');

            window.toggleHuntGame = function () {
                if (huntActive) {
                    stopHuntGame();
                } else {
                    startHuntGame();
                }
            };

            function startHuntGame() {
                // Stop other game if running
                if (typeof gameActive !== 'undefined' && gameActive) {
                    stopGame();
                }

                // Audio Labels setting is respected in Pop-Up Finder.


                // Choose target (from existing grid if available, else load)
                const occupied = gridData.map((it, i) => it ? i : null).filter(i => i !== null);
                if (occupied.length === 0) {
                    // No symbols: prompt to load
                    huntSelected = null;
                    openHuntPicker(true);
                    return;
                }

                // If already chosen, start immediately; otherwise open picker
                if (!huntSelected) {
                    openHuntPicker(false);
                    return;
                }

                beginHuntRound();
            }

            function beginHuntRound() {
                if (!huntSelected) return;

                // Always run the game in Play mode
                if (typeof setMode === 'function') {
                    setMode('play');
                } else {
                    config.mode = 'play';
                }

                huntActive = true;
                gridContainer.classList.add('hunt-outlines');
                // Apply current border settings to the full-grid outlines in this game mode
                const bw = (typeof config.borderWidth === 'number' ? config.borderWidth : 0);
                gridContainer.style.setProperty('--hunt-border-width', `${(bw > 0 ? bw : 1)}px`);
                gridContainer.style.setProperty('--hunt-border-color', config.borderColor || '#000000');

                huntBtn.innerText = "Stop";
                huntBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                huntBtn.classList.add('bg-red-500', 'hover:bg-red-600');

                // Snapshot the entire current grid so we can restore it when the game stops,
                // then clear the grid so ONLY the target symbol appears.
                huntRestore = gridData.map(it => it ? ({ ...it }) : null);
                gridData = Array(config.rows * config.cols).fill(null);
                huntCurrentIndex = null;

                renderGrid();

                // Place at first random location
                moveHuntTarget(true);
            }


            function stopHuntGame() {
                huntActive = false;
                huntMoving = false;
                gridContainer.classList.remove('hunt-outlines');
                gridContainer.style.removeProperty('--hunt-border-width');
                gridContainer.style.removeProperty('--hunt-border-color');
                huntBtn.innerText = "Start";
                huntBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                huntBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');

                // Restore the grid snapshot (if any)
                if (Array.isArray(huntRestore)) {
                    gridData = huntRestore;
                } else {
                    // Fallback: just clear the target if something went wrong
                    if (huntCurrentIndex !== null && gridData[huntCurrentIndex]) {
                        gridData[huntCurrentIndex] = null;
                    }
                }

                huntCurrentIndex = null;
                huntRestore = null;

                renderGrid();
                window.speechSynthesis.cancel();
            }


            function moveHuntTarget(first = false) {
                if (!huntActive || !huntSelected) return;

                // Clear previous
                if (huntCurrentIndex !== null) {
                    gridData[huntCurrentIndex] = null;
                }

                // Prefer empty cells; if none, allow any index (swap-less: overwrite temporarily)
                const empties = gridData.map((it, i) => it === null ? i : null).filter(i => i !== null);
                let candidates = empties.length > 0 ? empties : gridData.map((_, i) => i);

                // Avoid staying in the same spot if possible
                if (huntCurrentIndex !== null && candidates.length > 1) {
                    candidates = candidates.filter(i => i !== huntCurrentIndex);
                }

                const nextIndex = candidates[Math.floor(Math.random() * candidates.length)];
                huntCurrentIndex = nextIndex;

                // Place the target (ephemeral item)
                // Use spread to copy all properties (src, label, isShape, symbol, isTextOnly, colors, etc.)
                gridData[huntCurrentIndex] = { ...huntSelected };

                renderGrid();

                huntMoving = false;

                if (first) {
                    // Give a short instruction once at start (voice mode only)
                    if (config.audioEnabled) speak(`Find ${getSpeechLabel(huntSelected)}.`);
                }
            }

            function handleHuntPress(index, cellElement) {
                if (!huntActive) return;
                if (huntCurrentIndex === null) return;
                if (index === huntCurrentIndex) {
                    huntConfirmAndMove(cellElement);
                }
            }


            let huntMoving = false;
            function huntConfirmAndMove(cellElement) {
                if (huntMoving) return;
                huntMoving = true;

                // Visual feedback - Pop out animation
                if (cellElement) {
                    cellElement.classList.add('game-pop', 'ring-4', 'ring-green-500');
                    setTimeout(() => {
                        cellElement.classList.remove('game-pop', 'ring-4', 'ring-green-500');
                    }, 550);
                }

                // Confirmation: voice if enabled, otherwise beep
                if (config.audioEnabled) {
                    speak(`You found ${getSpeechLabel(huntSelected)}.`);
                } else {
                    playBeep();
                }

                // Move after animation completes
                setTimeout(() => moveHuntTarget(false), 600);
            }


            // --- Hunt Picker Modal ---
            window.openHuntPicker = function (forceLoad = false) {
                huntPendingChoice = null;
                huntConfirmBtn.disabled = true;
                huntPickerGrid.innerHTML = "";
                huntPickerHint.textContent = "";

                const occupied = gridData
                    .map((item, index) => item ? { item, index } : null)
                    .filter(x => x !== null);

                if (occupied.length === 0) {
                    huntPickerHint.textContent = "No symbols on the grid yet. Click Load Image to add one for the game.";
                    // If requested, auto-trigger load prompt
                    if (forceLoad) {
                        // leave modal open; user can hit Load Image
                    }
                } else {
                    huntPickerHint.textContent = "Tap a symbol to select it.";
                    for (const { item, index } of occupied) {
                        const btn = document.createElement('button');
                        btn.type = "button";
                        btn.className = "group relative aspect-square rounded-xl border border-slate-200 overflow-hidden bg-slate-50 hover:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500";
                        btn.onclick = () => {
                            // Visual selection
                            [...huntPickerGrid.querySelectorAll('button')].forEach(b => b.classList.remove('ring-2', 'ring-emerald-500'));
                            btn.classList.add('ring-2', 'ring-emerald-500');

                            // Copy all properties so shapes/text/colors work in the game
                            huntPendingChoice = { ...item, fromIndex: index };
                            huntConfirmBtn.disabled = false;
                        };

                        // Render content based on type
                        let contentEl;
                        if (item.isShape) {
                            contentEl = document.createElement('div');
                            contentEl.className = "w-full h-full flex items-center justify-center text-4xl";
                            contentEl.textContent = item.symbol;
                        } else if (item.isTextOnly) {
                            contentEl = document.createElement('div');
                            contentEl.className = "w-full h-full flex items-center justify-center text-sm font-bold p-1 text-center break-words";
                            contentEl.textContent = item.label;
                        } else {
                            contentEl = document.createElement('img');
                            contentEl.src = item.src;
                            contentEl.alt = item.label || "symbol";
                            contentEl.className = "w-full h-full object-contain p-2";
                        }

                        const cap = document.createElement('div');
                        cap.className = "absolute bottom-0 left-0 right-0 text-[11px] leading-tight bg-white/90 text-slate-700 px-1 py-0.5 truncate opacity-0 group-hover:opacity-100 transition-opacity";
                        cap.textContent = item.label || "";

                        btn.appendChild(contentEl);
                        btn.appendChild(cap);
                        huntPickerGrid.appendChild(btn);
                    }
                }

                huntModal.classList.remove('hidden');
            };

            window.closeHuntModal = function () {
                huntModal.classList.add('hidden');
            };

            window.confirmHuntChoice = function () {
                if (!huntPendingChoice) return;
                huntSelected = huntPendingChoice;
                huntPendingChoice = null;
                closeHuntModal();

                // If user pressed "Use Selected" while not active, start game
                if (!huntActive) {
                    beginHuntRound();
                }
            };

            window.triggerHuntLoad = function () {
                // Use existing single-file input; load image as dataURL for game use
                const input = document.getElementById('single-file-input') || document.getElementById('file-input');
                if (!input) return;

                input.onchange = async (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;

                    const label = formatLabel(file.name);
                    const reader = new FileReader();
                    reader.onload = () => {
                        const newItem = { src: reader.result, label, fromIndex: null };

                        // Create visual button for the new item
                        const btn = document.createElement('button');
                        btn.type = "button";
                        btn.className = "group relative aspect-square rounded-xl border border-slate-200 overflow-hidden bg-slate-50 hover:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 animate-fade-in-up";

                        const img = document.createElement('img');
                        img.src = reader.result;
                        img.className = "w-full h-full object-contain p-2";

                        const cap = document.createElement('div');
                        cap.className = "absolute bottom-0 left-0 right-0 text-[11px] leading-tight bg-white/90 text-slate-700 px-1 py-0.5 truncate opacity-0 group-hover:opacity-100 transition-opacity";
                        cap.textContent = label;

                        btn.appendChild(img);
                        btn.appendChild(cap);

                        btn.onclick = () => {
                            [...huntPickerGrid.querySelectorAll('button')].forEach(b => b.classList.remove('ring-2', 'ring-emerald-500'));
                            btn.classList.add('ring-2', 'ring-emerald-500');
                            huntPendingChoice = { ...newItem };
                            huntConfirmBtn.disabled = false;
                        };

                        // Add to grid and select it
                        huntPickerGrid.appendChild(btn);
                        btn.click();
                        btn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                        huntPickerHint.textContent = `Loaded: ${label}.`;
                    };
                    reader.readAsDataURL(file);

                    // reset input so selecting same file again works
                    input.value = "";
                };

                input.click();
            };


            // --- Find-It Game Logic ---
            function startGame() {
                // Stop other game if running
                if (typeof huntActive !== 'undefined' && huntActive) {
                    stopHuntGame();
                }

                gameActive = true;
                gameBtn.innerText = "Stop";
                gameBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                gameBtn.classList.add('bg-red-500', 'hover:bg-red-600');

                // Ensure Audio Labels are enabled for the game
                if (!config.audioEnabled) {
                    config.audioEnabled = true;
                    audioToggle.checked = true;
                }

                // Switch to play mode if not already
                if (config.mode !== 'play') {
                    setMode('play');
                }
                startFindItRound();
            }

            function stopGame() {
                gameActive = false;
                gameBtn.innerText = "Start";
                gameBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                gameBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                currentTargetIndex = null;
                window.speechSynthesis.cancel();
            }

            function startFindItRound() {
                if (!gameActive) return;

                // Helper function to check if an element is visible on screen
                function isElementVisible(element) {
                    if (!element) return false;
                    const rect = element.getBoundingClientRect();
                    const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
                    const viewportHeight = window.innerHeight || document.documentElement.clientHeight;

                    // Check if the element is at least partially visible in the viewport
                    return (
                        rect.bottom > 0 &&
                        rect.right > 0 &&
                        rect.top < viewportHeight &&
                        rect.left < viewportWidth
                    );
                }

                // Find all occupied cells that are visible on screen
                const occupiedIndices = gridData
                    .map((item, index) => item !== null ? index : null)
                    .filter(index => index !== null);

                // Filter to only include cells that are currently visible
                const visibleIndices = occupiedIndices.filter(index => {
                    const cellElement = gridContainer.children[index];
                    return isElementVisible(cellElement);
                });

                if (visibleIndices.length === 0) {
                    if (occupiedIndices.length > 0) {
                        speak("No symbols are visible on screen.");
                    } else {
                        speak("Please add some symbols first.");
                    }
                    stopGame();
                    return;
                }

                // Pick random target from visible cells only
                const randomIndex = Math.floor(Math.random() * visibleIndices.length);
                currentTargetIndex = visibleIndices[randomIndex];
                const targetItem = gridData[currentTargetIndex];

                // Pick random phrase from config
                const validPhrases = config.prompts.filter(p => p.trim() !== "");
                const randomPhrase = validPhrases.length > 0
                    ? validPhrases[Math.floor(Math.random() * validPhrases.length)]
                    : "Find";

                // Speak prompt after a short delay
                setTimeout(() => {
                    speak(`${randomPhrase} ${getSpeechLabel(targetItem)}`);
                }, 1000);
            }

            function checkAnswer(index) {
                if (!gameActive || currentTargetIndex === null) return;

                const clickedItem = gridData[index];
                const targetItem = gridData[currentTargetIndex];

                // Check if labels match (allowing multiple correct items)
                if (clickedItem && targetItem && clickedItem.label === targetItem.label) {
                    // Correct!
                    playChime();

                    // Visual feedback - Pop out animation (skip if already applied by magnify mode)
                    const cell = gridContainer.children[index];
                    if (cell && !cell.classList.contains('game-pop')) {
                        // Pop-out animation with green glow
                        cell.classList.add('game-pop', 'ring-4', 'ring-green-500');
                        setTimeout(() => {
                            cell.classList.remove('game-pop', 'ring-4', 'ring-green-500');
                        }, 550);
                    }

                    // 1. Speak the name immediately
                    speak(getSpeechLabel(targetItem), true);

                    // 2. Pause then Reinforcement
                    setTimeout(() => {
                        const validReinforcements = config.correctFeedback.filter(p => p.trim() !== "");
                        if (validReinforcements.length > 0) {
                            const randomReinforcement = validReinforcements[Math.floor(Math.random() * validReinforcements.length)];
                            speak(`${randomReinforcement} ${getSpeechLabel(targetItem)}`, true);
                        }
                    }, 1500);

                    // 3. Pause (after reinforcement) before next round based on slider
                    setTimeout(() => {
                        startFindItRound();
                    }, 1500 + (config.gameDelay * 1000));
                } else {
                    // Incorrect
                    if (clickedItem) {
                        const validIncorrect = config.incorrectFeedback.filter(p => p.trim() !== "");
                        if (validIncorrect.length > 0) {
                            let phrase = validIncorrect[Math.floor(Math.random() * validIncorrect.length)];
                            phrase = phrase.replace("[word]", getSpeechLabel(clickedItem));
                            speak(`${phrase} ${getSpeechLabel(targetItem)}`, true);
                        } else {
                            speak(`That's ${getSpeechLabel(clickedItem)}. Find ${getSpeechLabel(targetItem)}`, true);
                        }
                    } else {
                        speak(`Look for ${getSpeechLabel(targetItem)}`, true);
                    }
                }
            }

            // Helper function to activate a cell (with cooldown check)
            function activateCell(index, cellElement) {
                index = parseInt(index);

                // Game Mode Interception
                if (gameActive) {
                    checkAnswer(index);
                    return;
                }

                // Pop-Up Finder interception (when Magnify is OFF, clicks come through here)
                if (huntActive) {
                    if (huntCurrentIndex !== null && index === huntCurrentIndex) {
                        // Brief visual pulse
                        if (config.mode === 'play') {
                            cellElement.classList.add('pulse-active');
                            setTimeout(() => cellElement.classList.remove('pulse-active'), 500);
                        }
                        huntConfirmAndMove(cellElement);
                    }
                    return;
                }



                const now = Date.now();
                const timeSinceLastActivation = (now - lastActivationTime) / 1000;

                // Check cooldown (only if enabled)
                if (config.cooldownTime > 0 && timeSinceLastActivation < config.cooldownTime) {
                    return; // Still in cooldown period
                }

                // Update last activation time
                lastActivationTime = now;

                // In Play Mode, add pulse animation and audio feedback
                if (config.mode === 'play') {
                    // Add pulse animation
                    cellElement.classList.add('pulse-active');
                    setTimeout(() => {
                        cellElement.classList.remove('pulse-active');
                    }, 500);

                    // Audio feedback
                    if (config.audioEnabled) {
                        speak(getSpeechLabel(gridData[index]));
                    } else {
                        playChime();
                    }
                } else {
                    // In Edit Mode, no auto-speech on tap (use preview button)
                }
            }

            let lastTouchTime = 0;
            function handleCellClick(e) {
                // Ignore mouse events if they occur shortly after a touch event (fixes ghost clicks resetting dwell timer)
                if (e.type === 'touchstart') {
                    lastTouchTime = Date.now();
                } else if (e.type === 'mousedown' && Date.now() - lastTouchTime < 800) {
                    return;
                }
                if (e.target.closest('.delete-btn')) return;
                if (e.target.closest('.label-btn')) return;
                if (e.target.closest('.color-pick-btn')) return;

                // If using Magnify in Play Mode, speech is handled on release (handleMagnifyEnd)
                if (config.mode === 'play' && config.magnify) return;

                // Games (Pop-Up Finder & Find-It): always activate immediately on press (ignore dwell)
                if ((huntActive || gameActive) && config.mode === 'play' && !config.magnify) {
                    const index = this.dataset.index;
                    // For Find-It game, check if cell has data; for Pop-Up finder, logic handles it
                    if (gridData[index]) activateCell(index, this);
                    return;
                }

                const index = this.dataset.index;
                if (!gridData[index]) return;

                const cellElement = this;

                // If dwell time is 0 (off), activate immediately
                if (config.dwellTime === 0) {
                    activateCell(index, cellElement);
                    return;
                }

                // Clear any existing dwell timer
                if (dwellTimer) {
                    clearTimeout(dwellTimer);
                    dwellTimer = null;
                }

                // Start dwell timer
                dwellTimer = setTimeout(() => {
                    activateCell(index, cellElement);
                    dwellTimer = null;
                }, config.dwellTime * 1000);
            }

            // Cancel dwell if mouse/touch leaves before dwell time completes
            function handleCellLeave(e) {
                if (dwellTimer) {
                    clearTimeout(dwellTimer);
                    dwellTimer = null;
                }
            }

            window.deleteImage = function (index) {
                gridData[index] = null;
                renderGrid();
            };

            // --- Speech Label Modal Logic ---
            let speechLabelEditingIndex = null;
            const speechLabelModal = document.getElementById('speech-label-modal');
            const speechLabelInput = document.getElementById('speech-label-input');
            const speechLabelDefault = document.getElementById('speech-label-default');

            // --- Speech Label Persistence (localStorage) ---
            const SPEECH_LABELS_STORAGE_KEY = 'aac_speech_labels';

            function loadSpeechLabelsFromStorage() {
                try {
                    const stored = localStorage.getItem(SPEECH_LABELS_STORAGE_KEY);
                    return stored ? JSON.parse(stored) : {};
                } catch (e) {
                    console.warn('Failed to load speech labels from storage:', e);
                    return {};
                }
            }

            function saveSpeechLabelToStorage(filename, speechLabel) {
                try {
                    const labels = loadSpeechLabelsFromStorage();
                    if (speechLabel && speechLabel.trim() !== '') {
                        labels[filename] = speechLabel;
                    } else {
                        delete labels[filename];
                    }
                    localStorage.setItem(SPEECH_LABELS_STORAGE_KEY, JSON.stringify(labels));
                } catch (e) {
                    console.warn('Failed to save speech label to storage:', e);
                }
            }

            function getSavedSpeechLabel(filename) {
                const labels = loadSpeechLabelsFromStorage();
                return labels[filename] || '';
            }

            // Helper function to fit text to a container (fills 75% of width)
            function fitTextToContainer(textElement, containerElement, targetWidthPercent = 0.75) {
                // Start with a large font size and reduce until it fits
                const containerWidth = containerElement.offsetWidth;
                const containerHeight = containerElement.offsetHeight;
                const targetWidth = containerWidth * targetWidthPercent;
                const maxHeight = containerHeight * 0.8; // Don't exceed 80% of height

                let fontSize = 100; // Start large
                const minFontSize = 12;

                textElement.style.fontSize = fontSize + 'px';

                // Binary search for optimal font size
                let low = minFontSize;
                let high = fontSize;

                while (high - low > 1) {
                    fontSize = Math.floor((low + high) / 2);
                    textElement.style.fontSize = fontSize + 'px';

                    if (textElement.scrollWidth <= targetWidth && textElement.scrollHeight <= maxHeight) {
                        low = fontSize;
                    } else {
                        high = fontSize;
                    }
                }

                textElement.style.fontSize = low + 'px';
            }

            // Helper function to get the effective speech label
            function getSpeechLabel(item) {
                if (!item) return '';
                // Use speechLabel if defined and non-empty, otherwise fall back to label
                return (item.speechLabel && item.speechLabel.trim() !== '') ? item.speechLabel : (item.label || '');
            }

            window.openSpeechLabelModal = function (index) {
                speechLabelEditingIndex = index;
                const item = gridData[index];
                if (!item) return;

                speechLabelDefault.textContent = item.label || '(No filename)';
                speechLabelInput.value = item.speechLabel || '';
                speechLabelModal.classList.remove('hidden');

                // Focus the input after a short delay
                setTimeout(() => speechLabelInput.focus(), 100);
            };

            window.closeSpeechLabelModal = function () {
                speechLabelModal.classList.add('hidden');
                speechLabelEditingIndex = null;
            };

            window.saveSpeechLabel = function () {
                if (speechLabelEditingIndex === null) return;
                const item = gridData[speechLabelEditingIndex];
                if (!item) return;

                const newLabel = speechLabelInput.value.trim();
                item.speechLabel = newLabel;

                // Persist to localStorage using the filename (label) as the key
                saveSpeechLabelToStorage(item.label, newLabel);

                closeSpeechLabelModal();
                renderGrid();
            };

            window.clearSpeechLabel = function () {
                if (speechLabelEditingIndex === null) return;
                const item = gridData[speechLabelEditingIndex];
                if (!item) return;

                item.speechLabel = '';
                speechLabelInput.value = '';

                // Remove from localStorage
                saveSpeechLabelToStorage(item.label, '');

                closeSpeechLabelModal();
                renderGrid();
            };

            // --- Text Label Modal Logic (for text-only cells) ---
            let textLabelTargetIndex = null;
            let currentContourColor = '#ef4444'; // Default red
            const textLabelModal = document.getElementById('text-label-modal');
            const textLabelInput = document.getElementById('text-label-input');
            const textLabelPreview = document.getElementById('text-label-preview');
            const textContourToggle = document.getElementById('text-contour-toggle');
            const contourControls = document.getElementById('contour-controls');
            const contourWidthRange = document.getElementById('contour-width-range');
            const contourWidthVal = document.getElementById('contour-width-val');
            const contourGapRange = document.getElementById('contour-gap-range');
            const contourGapVal = document.getElementById('contour-gap-val');

            let previewUpdateFrame = null;

            function getContourFilterUrl(radius, color, closeCounters = false) {
                const encodedColor = encodeURIComponent(color);
                // Contour-following bubble outline filter:
                // Uses minimal blur to preserve letter shape detail while smoothing jagged dilation edges
                const blurAmount = Math.max(radius * 0.15, 0.5);

                if (closeCounters) {
                    // Gap layer: First close internal counters (holes in letters like 'o', 'a', 'e') 
                    // by dilating then eroding, then apply the requested dilation
                    // This ensures the gap layer fills letter holes to hide the outline color behind
                    const closeRadius = 4; // Enough to close most letter counters
                    return `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"><filter id="f" x="-50%" y="-50%" width="200%" height="200%"><feMorphology operator="dilate" radius="${closeRadius}" in="SourceAlpha" result="close1"/><feMorphology operator="erode" radius="${closeRadius}" in="close1" result="closed"/><feMorphology operator="dilate" radius="${radius}" in="closed" result="dilate"/><feGaussianBlur stdDeviation="${blurAmount}" in="dilate" result="blur"/><feComponentTransfer in="blur" result="sharp"><feFuncA type="table" tableValues="0 0 0.1 0.6 1 1 1 1"/></feComponentTransfer><feFlood flood-color="${encodedColor}" result="color"/><feComposite operator="in" in="color" in2="sharp"/></filter></svg>#f')`;
                } else {
                    // Outline layer: Standard dilation (counters get filled, but gap layer will cover them)
                    return `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"><filter id="f" x="-50%" y="-50%" width="200%" height="200%"><feMorphology operator="dilate" radius="${radius}" in="SourceAlpha" result="dilate"/><feGaussianBlur stdDeviation="${blurAmount}" in="dilate" result="blur"/><feComponentTransfer in="blur" result="sharp"><feFuncA type="table" tableValues="0 0 0.1 0.6 1 1 1 1"/></feComponentTransfer><feFlood flood-color="${encodedColor}" result="color"/><feComposite operator="in" in="color" in2="sharp"/></filter></svg>#f')`;
                }
            }

            function updateTextLabelPreview() {
                if (!textLabelPreview) return;

                if (previewUpdateFrame) cancelAnimationFrame(previewUpdateFrame);

                previewUpdateFrame = requestAnimationFrame(() => {
                    const text = textLabelInput.value.trim() || 'Preview';
                    textLabelPreview.textContent = text;
                    textLabelPreview.setAttribute('data-text', text);
                    textLabelPreview.style.color = config.labelColor || '#000000';

                    const active = textContourToggle ? textContourToggle.checked : false;

                    if (active) {
                        const width = contourWidthRange ? parseInt(contourWidthRange.value) : 6;
                        const gap = contourGapRange ? parseInt(contourGapRange.value) : 3;
                        const color = currentContourColor;

                        // Use SVG Filters (Dilation) instead of Stroke to avoid inner artifacts
                        // Dilation radius ~ Stroke Width / 2
                        // We want Total Outline to extend (Gap + Width)
                        // We want Gap (White) to extend (Gap)

                        const gapRadius = gap;
                        const totalRadius = gap + width;

                        textLabelPreview.classList.add('text-cell-contour');

                        // Set Filter URLs
                        // Gap layer uses closeCounters=true to fill letter holes (like in 'o', 'a', 'e')
                        // Outline layer is standard - its filled counters will be covered by gap layer
                        const gapFilter = getContourFilterUrl(gapRadius, '#ffffff', true);
                        const outlineFilter = getContourFilterUrl(totalRadius, color);

                        textLabelPreview.style.setProperty('--contour-filter-gap', gapFilter);
                        textLabelPreview.style.setProperty('--contour-filter-outline', outlineFilter);

                        // Legacy cleanup
                        textLabelPreview.style.removeProperty('--contour-gap-width');
                        textLabelPreview.style.removeProperty('--contour-total-width');
                        textLabelPreview.style.removeProperty('--contour-color');
                        textLabelPreview.style.webkitTextStroke = 'initial';
                    } else {
                        textLabelPreview.classList.remove('text-cell-contour');
                        textLabelPreview.style.removeProperty('--contour-filter-gap');
                        textLabelPreview.style.removeProperty('--contour-filter-outline');
                    }
                    previewUpdateFrame = null;
                });
            }

            // Text Contour Event Listeners
            if (textContourToggle) {
                textContourToggle.addEventListener('change', () => {
                    if (textContourToggle.checked) {
                        contourControls.classList.remove('hidden');
                    } else {
                        contourControls.classList.add('hidden');
                    }
                    updateTextLabelPreview();
                });
            }
            if (contourWidthRange) {
                contourWidthRange.addEventListener('input', () => {
                    contourWidthVal.innerText = `${contourWidthRange.value}px`;
                    updateTextLabelPreview();
                });
            }
            if (contourGapRange) {
                contourGapRange.addEventListener('input', () => {
                    contourGapVal.innerText = `${contourGapRange.value}px`;
                    updateTextLabelPreview();
                });
            }
            if (textLabelInput) {
                textLabelInput.addEventListener('input', updateTextLabelPreview);
            }

            window.setTextContourColor = function (color, btn) {
                currentContourColor = color;
                document.querySelectorAll('.contour-color-btn').forEach(b => {
                    b.classList.remove('ring-blue-500', 'ring-offset-2');
                    b.classList.add('ring-transparent');
                    b.style.transform = 'scale(1)';
                });
                if (btn) {
                    btn.classList.remove('ring-transparent');
                    btn.classList.add('ring-blue-500', 'ring-offset-2');
                    btn.style.transform = 'scale(1.1)';
                }
                updateTextLabelPreview();
            };

            window.openTextLabelModal = function (index) {
                textLabelTargetIndex = index;
                const existingItem = gridData[index];

                // Reset UI Defaults
                if (textContourToggle) textContourToggle.checked = false;
                if (contourControls) contourControls.classList.add('hidden');
                currentContourColor = '#ef4444';
                if (contourWidthRange) contourWidthRange.value = 8;
                if (contourGapRange) contourGapRange.value = 4;
                if (contourWidthVal) contourWidthVal.innerText = '8px';
                if (contourGapVal) contourGapVal.innerText = '4px';

                // Reset visual selection of color buttons
                document.querySelectorAll('.contour-color-btn').forEach(btn => {
                    btn.classList.remove('ring-blue-500', 'ring-offset-2');
                    btn.classList.add('ring-transparent');
                    btn.style.transform = 'scale(1)';
                    // Default select red if no existing item
                    if (btn.getAttribute('style').includes('#ef4444') && (!existingItem || !existingItem.contourActive)) {
                        btn.classList.remove('ring-transparent');
                        btn.classList.add('ring-blue-500', 'ring-offset-2');
                        btn.style.transform = 'scale(1.1)';
                    }
                });

                // If editing an existing text-only cell, pre-fill the input
                if (existingItem && existingItem.isTextOnly) {
                    textLabelInput.value = existingItem.label || '';
                    document.querySelector('#text-label-modal h3').textContent = 'Edit Text Label';

                    // Load contour settings
                    if (existingItem.contourActive) {
                        if (textContourToggle) textContourToggle.checked = true;
                        if (contourControls) contourControls.classList.remove('hidden');
                        currentContourColor = existingItem.contourColor || '#ef4444';
                        if (contourWidthRange) contourWidthRange.value = existingItem.contourWidth || 8;
                        if (contourGapRange) contourGapRange.value = (existingItem.contourGap !== undefined) ? existingItem.contourGap : 4;
                        if (contourWidthVal) contourWidthVal.innerText = `${contourWidthRange.value}px`;
                        if (contourGapVal) contourGapVal.innerText = `${contourGapRange.value}px`;

                        // Update button selection
                        document.querySelectorAll('.contour-color-btn').forEach(btn => {
                            // Normalize color check (simple containment)
                            if (btn.getAttribute('style').includes(currentContourColor)) {
                                // De-select others (already done above, but safe to ensure)
                                document.querySelectorAll('.contour-color-btn').forEach(b => {
                                    b.classList.remove('ring-blue-500', 'ring-offset-2');
                                    b.classList.add('ring-transparent');
                                    b.style.transform = 'scale(1)';
                                });
                                btn.classList.remove('ring-transparent');
                                btn.classList.add('ring-blue-500', 'ring-offset-2');
                                btn.style.transform = 'scale(1.1)';
                            }
                        });
                    }
                } else {
                    textLabelInput.value = '';
                    document.querySelector('#text-label-modal h3').textContent = 'Add Text Label';
                }

                updateTextLabelPreview();
                textLabelModal.classList.remove('hidden');
                setTimeout(() => textLabelInput.focus(), 100);
            };

            window.closeTextLabelModal = function () {
                textLabelModal.classList.add('hidden');
                textLabelTargetIndex = null;
            };

            window.saveTextLabel = function () {
                if (textLabelTargetIndex === null) return;
                const text = textLabelInput.value.trim();
                if (!text) {
                    closeTextLabelModal();
                    return;
                }

                const contourActive = textContourToggle ? textContourToggle.checked : false;
                const contourWidth = contourWidthRange ? parseInt(contourWidthRange.value) : 8;
                const contourGap = contourGapRange ? parseInt(contourGapRange.value) : 4;

                // Create or update a text-only cell
                gridData[textLabelTargetIndex] = {
                    isTextOnly: true,
                    label: text,
                    src: null,
                    speechLabel: '', // For text-only, label IS the speech
                    customBgColor: gridData[textLabelTargetIndex]?.customBgColor || null,
                    customBorderColor: gridData[textLabelTargetIndex]?.customBorderColor || null,
                    // Contour Data
                    contourActive: contourActive,
                    contourColor: currentContourColor,
                    contourWidth: contourWidth,
                    contourGap: contourGap
                };

                closeTextLabelModal();
                renderGrid();
            };

            // --- Shapes Modal Logic (for emoji/symbol cells) ---
            let shapesTargetIndex = null;
            const shapesModal = document.getElementById('shapes-modal');

            window.openShapesModal = function (index) {
                shapesTargetIndex = index;
                shapesModal.classList.remove('hidden');
                // Focus search input and ensure Attribution is visible
                setTimeout(() => {
                    const input = document.getElementById('arasaac-search-input');
                    if (input) input.focus();
                }, 100);
            };

            window.closeShapesModal = function () {
                shapesModal.classList.add('hidden');
                shapesTargetIndex = null;
            };

            // Helper to handle shape button clicks
            function selectShape(symbol, label) {
                if (shapesTargetIndex === null) return;

                // Create a shape cell
                gridData[shapesTargetIndex] = {
                    isShape: true,
                    symbol: symbol,
                    label: label,
                    src: null,
                    speechLabel: '',
                    customBgColor: null,
                    customBorderColor: null,
                    symbolColor: null // For custom symbol color
                };

                closeShapesModal();
                renderGrid();
            }

            // Attach click handlers to shape buttons
            document.querySelectorAll('.shape-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const symbol = btn.dataset.symbol;
                    const label = btn.dataset.label;
                    selectShape(symbol, label);
                });
            });

            // --- ARASAAC Symbol Search API ---
            const ARASAAC_API_BASE = 'https://api.arasaac.org/v1';
            const arasaacSearchInput = document.getElementById('arasaac-search-input');
            const arasaacResults = document.getElementById('arasaac-results');
            const arasaacAttribution = document.getElementById('arasaac-attribution');
            let arasaacSearchTimeout = null;
            let lastArasaacSearch = '';



            // Debounced ARASAAC search
            if (arasaacSearchInput) {
                arasaacSearchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();

                    if (arasaacSearchTimeout) {
                        clearTimeout(arasaacSearchTimeout);
                    }

                    if (query.length < 2) {
                        showArasaacEmptyState();
                        return;
                    }

                    arasaacSearchTimeout = setTimeout(() => {
                        searchArasaac(query);
                    }, 400);
                });

                // Handle Enter key
                arasaacSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = e.target.value.trim();
                        if (query.length >= 2) {
                            if (arasaacSearchTimeout) clearTimeout(arasaacSearchTimeout);
                            searchArasaac(query);
                        }
                    }
                });
            }

            // Search ARASAAC API
            window.searchArasaac = async function (query) {
                if (!query || query.length < 2) return;
                if (query === lastArasaacSearch) return;
                lastArasaacSearch = query;

                // Update search input if called from popular button
                if (arasaacSearchInput) {
                    arasaacSearchInput.value = query;
                }

                showArasaacLoading();

                try {
                    const response = await fetch(`${ARASAAC_API_BASE}/pictograms/en/search/${encodeURIComponent(query)}`);

                    if (!response.ok) {
                        throw new Error('Search failed');
                    }

                    const data = await response.json();

                    if (!data || data.length === 0) {
                        showArasaacNoResults(query);
                        return;
                    }

                    // Limit results to first 24 for performance
                    const results = data.slice(0, 24);
                    displayArasaacResults(results);

                } catch (error) {
                    console.error('ARASAAC search error:', error);
                    showArasaacError();
                }
            };

            function showArasaacLoading() {
                if (!arasaacResults) return;
                arasaacResults.innerHTML = `
                    <div class="arasaac-loading">
                        <div class="arasaac-loading-spinner"></div>
                        <p class="mt-3">Searching...</p>
                    </div>
                `;
            }

            function showArasaacEmptyState() {
                if (!arasaacResults) return;
                lastArasaacSearch = '';
                arasaacResults.innerHTML = `
                    <div class="arasaac-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <p class="font-medium">Search for ARASAAC symbols</p>
                        <p class="text-sm mt-1">Type a word to find pictograms</p>
                    </div>
                `;
            }

            function showArasaacNoResults(query) {
                if (!arasaacResults) return;
                arasaacResults.innerHTML = `
                    <div class="arasaac-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        <p class="font-medium">No symbols found for "${query}"</p>
                        <p class="text-sm mt-1">Try a different search term</p>
                    </div>
                `;
            }

            function showArasaacError() {
                if (!arasaacResults) return;
                arasaacResults.innerHTML = `
                    <div class="arasaac-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p class="font-medium">Unable to search</p>
                        <p class="text-sm mt-1">Please check your connection and try again</p>
                    </div>
                `;
            }

            function displayArasaacResults(results) {
                if (!arasaacResults) return;

                arasaacResults.innerHTML = results.map(item => {
                    const id = item._id;
                    const keywords = item.keywords || [];
                    // Get the first English keyword as label
                    const keyword = keywords.find(k => k.keyword) || {};
                    const label = keyword.keyword || `Symbol ${id}`;
                    const imageUrl = `https://static.arasaac.org/pictograms/${id}/${id}_500.png`;

                    return `
                        <button class="arasaac-symbol-btn" onclick="selectArasaacSymbol('${id}', '${label.replace(/'/g, "\\'")}', '${imageUrl}')">
                            <img src="${imageUrl}" alt="${label}" loading="lazy">
                            <span class="symbol-label">${label}</span>
                        </button>
                    `;
                }).join('');
            }

            // Select an ARASAAC symbol
            window.selectArasaacSymbol = function (id, label, imageUrl) {
                if (shapesTargetIndex === null) return;

                // Create an ARASAAC image cell
                gridData[shapesTargetIndex] = {
                    isArasaac: true,
                    arasaacId: id,
                    src: imageUrl,
                    label: label,
                    speechLabel: '',
                    customBgColor: null,
                    customBorderColor: null
                };

                closeShapesModal();
                renderGrid();
            };

            // --- Tab Switching Logic ---
            let currentSymbolTab = 'arasaac';

            window.switchSymbolTab = function (tabName) {
                currentSymbolTab = tabName;

                // Update tab buttons
                document.getElementById('tab-arasaac').classList.toggle('active', tabName === 'arasaac');
                document.getElementById('tab-mulberry').classList.toggle('active', tabName === 'mulberry');

                // Toggle tab content
                document.getElementById('arasaac-tab-content').classList.toggle('hidden', tabName !== 'arasaac');
                document.getElementById('mulberry-tab-content').classList.toggle('hidden', tabName !== 'mulberry');

                // Toggle attributions
                document.getElementById('arasaac-attribution').classList.toggle('hidden', tabName !== 'arasaac');
                document.getElementById('mulberry-attribution').classList.toggle('hidden', tabName !== 'mulberry');
            };

            // --- PiCom AI Symbol Search (via Global Symbols API) ---
            const PICOM_API_BASE = 'https://globalsymbols.com/api/v1';
            const PICOM_SYMBOLSET = 'ai-realistic-symbols-a-picom-collection';
            const mulberrySearchInput = document.getElementById('mulberry-search-input');
            const mulberryResults = document.getElementById('mulberry-results');
            const mulberryAttribution = document.getElementById('mulberry-attribution');
            let mulberrySearchTimeout = null;
            let lastMulberrySearch = '';

            // Debounced Mulberry search
            if (mulberrySearchInput) {
                mulberrySearchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();

                    if (mulberrySearchTimeout) {
                        clearTimeout(mulberrySearchTimeout);
                    }

                    if (query.length < 2) {
                        showMulberryEmptyState();
                        return;
                    }

                    mulberrySearchTimeout = setTimeout(() => {
                        searchMulberry(query);
                    }, 400);
                });

                // Handle Enter key
                mulberrySearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = e.target.value.trim();
                        if (query.length >= 2) {
                            if (mulberrySearchTimeout) clearTimeout(mulberrySearchTimeout);
                            searchMulberry(query);
                        }
                    }
                });
            }

            // Search PiCom AI symbols via Global Symbols API
            window.searchMulberry = async function (query) {
                if (!query || query.length < 2) return;
                if (query === lastMulberrySearch) return;
                lastMulberrySearch = query;

                // Update search input if called from popular button
                if (mulberrySearchInput) {
                    mulberrySearchInput.value = query;
                }

                showMulberryLoading();

                try {
                    const apiUrl = `${PICOM_API_BASE}/labels/search?query=${encodeURIComponent(query)}&symbolset=${PICOM_SYMBOLSET}&language=en&language_iso_format=639-1&limit=24`;

                    const response = await fetch(apiUrl);

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data || data.length === 0) {
                        showMulberryNoResults(query);
                        return;
                    }

                    displayMulberryResults(data);

                } catch (error) {
                    console.error('PiCom AI search error:', error);

                    // Check if this is likely a CORS error (common when running from file://)
                    if (error.name === 'TypeError' && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                        showMulberryCorsError();
                    } else {
                        showMulberryError();
                    }
                }
            };

            function showMulberryLoading() {
                if (!mulberryResults) return;
                mulberryResults.innerHTML = `
                    <div class="mulberry-loading">
                        <div class="mulberry-loading-spinner"></div>
                        <p class="mt-3">Searching...</p>
                    </div>
                `;
            }

            function showMulberryEmptyState() {
                if (!mulberryResults) return;
                lastMulberrySearch = '';
                mulberryResults.innerHTML = `
                    <div class="mulberry-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <p class="font-medium">Search for Mulberry symbols</p>
                        <p class="text-sm mt-1">Adult-friendly AAC pictograms</p>
                    </div>
                `;
            }

            function showMulberryNoResults(query) {
                if (!mulberryResults) return;
                mulberryResults.innerHTML = `
                    <div class="mulberry-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        <p class="font-medium">No symbols found for "${query}"</p>
                        <p class="text-sm mt-1">Try a different search term</p>
                    </div>
                `;
            }

            function showMulberryError() {
                if (!mulberryResults) return;
                mulberryResults.innerHTML = `
                    <div class="mulberry-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p class="font-medium">Unable to search</p>
                        <p class="text-sm mt-1">Please check your connection and try again</p>
                    </div>
                `;
            }

            function showMulberryCorsError() {
                if (!mulberryResults) return;
                mulberryResults.innerHTML = `
                    <div class="mulberry-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            <path d="M12 8v4"></path>
                            <path d="M12 16h.01"></path>
                        </svg>
                        <p class="font-medium">Photographs Unavailable</p>
                        <p class="text-sm mt-1">Photo symbols require the app to run from a web server</p>
                        <p class="text-xs mt-2 text-slate-400">Use Line Drawings instead, or serve this file via a local server</p>
                    </div>
                `;
            }

            function displayMulberryResults(results) {
                if (!mulberryResults) return;

                mulberryResults.innerHTML = results.map(item => {
                    // Global Symbols API structure
                    const label = item.text || 'Symbol';
                    const imageUrl = item.picto?.image_url || '';
                    const symbolId = item.picto?.id || item.id || '';

                    if (!imageUrl) return ''; // Skip items without images

                    return `
                        <button class="mulberry-symbol-btn" onclick="selectMulberrySymbol('${symbolId}', '${label.replace(/'/g, "\\'")}', '${imageUrl}')">
                            <img src="${imageUrl}" alt="${label}" loading="lazy" onerror="this.parentElement.style.display='none'">
                            <span class="symbol-label">${label}</span>
                        </button>
                    `;
                }).join('');
            }

            // Select a Mulberry symbol
            window.selectMulberrySymbol = function (id, label, imageUrl) {
                if (shapesTargetIndex === null) return;

                // Create a Mulberry image cell (similar structure to ARASAAC)
                gridData[shapesTargetIndex] = {
                    isMulberry: true,
                    mulberryId: id,
                    src: imageUrl,
                    label: label,
                    speechLabel: '',
                    customBgColor: null,
                    customBorderColor: null
                };

                closeShapesModal();
                renderGrid();
            };

            // --- Symbol Color Modal Logic ---
            let symbolColorEditingIndex = null;
            const symbolColorModal = document.getElementById('symbol-color-modal');
            const symbolBgPreview = document.getElementById('symbol-bg-preview');
            const symbolBorderPreview = document.getElementById('symbol-border-preview');

            window.openSymbolColorModal = function (index) {
                symbolColorEditingIndex = index;
                const item = gridData[index];
                if (!item) return;

                // Update preview text
                updateSymbolColorPreviews(item);

                symbolColorModal.classList.remove('hidden');
            };

            window.closeSymbolColorModal = function () {
                symbolColorModal.classList.add('hidden');
                symbolColorEditingIndex = null;
            };

            function updateSymbolColorPreviews(item) {
                if (!item) return;
                symbolBgPreview.textContent = item.customBgColor ? `Current: ${item.customBgColor}` : 'Current: Default';
                symbolBorderPreview.textContent = item.customBorderColor ? `Current: ${item.customBorderColor}` : 'Current: Default';
            }

            window.setSymbolBgColor = function (color) {
                if (symbolColorEditingIndex === null) return;
                const item = gridData[symbolColorEditingIndex];
                if (!item) return;

                item.customBgColor = color;
                updateSymbolColorPreviews(item);
                renderGrid();
            };

            window.clearSymbolBgColor = function () {
                if (symbolColorEditingIndex === null) return;
                const item = gridData[symbolColorEditingIndex];
                if (!item) return;

                item.customBgColor = null;
                updateSymbolColorPreviews(item);
                renderGrid();
            };

            window.setSymbolBorderColor = function (color) {
                if (symbolColorEditingIndex === null) return;
                const item = gridData[symbolColorEditingIndex];
                if (!item) return;

                item.customBorderColor = color;
                updateSymbolColorPreviews(item);
                renderGrid();
            };

            window.clearSymbolBorderColor = function () {
                if (symbolColorEditingIndex === null) return;
                const item = gridData[symbolColorEditingIndex];
                if (!item) return;

                item.customBorderColor = null;
                updateSymbolColorPreviews(item);
                renderGrid();
            };

            window.clearAllSymbolColors = function () {
                if (symbolColorEditingIndex === null) return;
                const item = gridData[symbolColorEditingIndex];
                if (!item) return;

                item.customBgColor = null;
                item.customBorderColor = null;
                updateSymbolColorPreviews(item);
                renderGrid();
            };

            function renderGrid() {
                const hasImages = gridData.some(item => item !== null);

                gridContainer.classList.remove('hidden');

                // Update counts
                const count = gridData.filter(i => i !== null).length;
                fileCountSpan.innerText = `${count} symbols`;

                // Toggle visibility of status and clear button
                if (hasImages && config.mode === 'edit') {
                    fileStatus.classList.remove('hidden');
                    clearAllBtn.classList.remove('hidden');
                } else {
                    fileStatus.classList.add('hidden');
                    clearAllBtn.classList.add('hidden');
                }

                // Check for hidden icons
                const visibleCount = config.rows * config.cols;
                const hiddenIcons = gridData.slice(visibleCount).some(item => item !== null);
                const warningEl = document.getElementById('hidden-icons-warning');

                if (hiddenIcons && !warningDismissed) {
                    warningEl.classList.remove('hidden');
                } else {
                    warningEl.classList.add('hidden');
                }



                gridContainer.innerHTML = '';
                gridContainer.style.gridTemplateColumns = `repeat(${config.cols}, minmax(0, 1fr))`;
                gridContainer.style.gridTemplateRows = `repeat(${config.rows}, minmax(0, 1fr))`;
                gridContainer.style.gap = `${config.gap}px`;
                gridContainer.style.padding = `${config.gap}px`;

                // Only render up to the current visible size
                // visibleCount is already calculated above

                for (let index = 0; index < visibleCount; index++) {
                    // Ensure gridData has an entry (just in case)
                    if (index >= gridData.length) gridData.push(null);

                    const item = gridData[index];
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.index = index;

                    // Add compact-buttons class when there are 4+ rows (cells are shorter)
                    if (config.rows >= 4) {
                        cell.classList.add('compact-buttons');
                    }


                    // Border styling:
                    // - Normal mode: occupied cells get the configured border; empty cells use dashed placeholders via CSS.
                    // - Pop-Up Finder (huntActive): ALL cells get the configured border so full grid outlines are visible.
                    // - Custom border color per symbol overrides the global setting
                    // - borderWidth 0 = no border on occupied cells
                    const borderColor = (item && item.customBorderColor) ? item.customBorderColor : config.borderColor;
                    if (config.borderWidth > 0) {
                        if (huntActive || item) {
                            cell.style.border = `${config.borderWidth}px solid ${borderColor}`;
                        }
                    } else {
                        // No border when borderWidth is 0
                        if (item) {
                            cell.style.border = 'none';
                        } else if (huntActive) {
                            // Still show borders in hunt mode for empty cells
                            cell.style.border = '1px solid #e2e8f0';
                        }
                    }

                    // Custom background color per symbol
                    if (item && item.customBgColor) {
                        cell.style.backgroundColor = item.customBgColor;
                    }
                    if (item) {
                        cell.classList.add('occupied');
                        cell.addEventListener('mousedown', handleCellClick);
                        cell.addEventListener('mouseleave', handleCellLeave);
                        cell.addEventListener('mouseup', handleCellLeave);
                        cell.addEventListener('touchstart', handleCellClick);
                        cell.addEventListener('touchend', handleCellLeave);
                        cell.addEventListener('touchcancel', handleCellLeave);

                        if (config.mode === 'edit') {
                            cell.classList.add('editable');
                            cell.setAttribute('draggable', 'true');

                            const delBtn = document.createElement('div');
                            delBtn.className = 'delete-btn';
                            delBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
                            delBtn.onclick = (e) => {
                                e.stopPropagation();
                                deleteImage(index);
                            };
                            cell.appendChild(delBtn);

                            const previewBtn = document.createElement('div');
                            previewBtn.className = 'preview-btn';
                            previewBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
                            previewBtn.onclick = (e) => {
                                e.stopPropagation();
                                if (config.audioEnabled) {
                                    speak(getSpeechLabel(item));
                                } else {
                                    playChime();
                                }
                            };
                            cell.appendChild(previewBtn);

                            // Speech Label / Edit Text Button
                            // Always show in edit mode for all cell types
                            // For text-only cells, this edits the text directly
                            // For shape cells and image cells, used for speech labels
                            {
                                const labelBtn = document.createElement('div');
                                if (item.isTextOnly) {
                                    // For text-only cells, always show and opens text editor
                                    labelBtn.className = 'label-btn has-label';
                                    labelBtn.title = 'Edit Text Label';
                                } else if (item.isShape) {
                                    // For shape cells, edit speech label
                                    labelBtn.className = 'label-btn' + (item.speechLabel ? ' has-label' : '');
                                    labelBtn.title = item.speechLabel ? `Speech: ${item.speechLabel}` : 'Set Speech Label';
                                } else {
                                    labelBtn.className = 'label-btn' + (item.speechLabel ? ' has-label' : '');
                                    labelBtn.title = item.speechLabel ? `Speech Label: ${item.speechLabel}` : 'Set Speech Label';
                                }
                                labelBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>`;
                                labelBtn.onclick = (e) => {
                                    e.stopPropagation();
                                    if (item.isTextOnly) {
                                        openTextLabelModal(index);
                                    } else {
                                        openSpeechLabelModal(index);
                                    }
                                };
                                cell.appendChild(labelBtn);
                            }

                            // Symbol Color Button
                            const colorPickBtn = document.createElement('div');
                            const hasCustomColor = item.customBgColor || item.customBorderColor;
                            colorPickBtn.className = 'color-pick-btn' + (hasCustomColor ? ' has-custom' : '');
                            colorPickBtn.title = hasCustomColor ? 'Custom Colors Set' : 'Set Symbol Colors';
                            colorPickBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="10.5" r="2.5"></circle><circle cx="8.5" cy="7.5" r="2.5"></circle><circle cx="6.5" cy="12.5" r="2.5"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"></path></svg>`;
                            colorPickBtn.onclick = (e) => {
                                e.stopPropagation();
                                openSymbolColorModal(index);
                            };
                            cell.appendChild(colorPickBtn);

                            cell.addEventListener('dragstart', handleDragStart);
                            cell.addEventListener('touchstart', handleEditTouchStart, { passive: false });
                            cell.addEventListener('touchmove', handleEditTouchMove, { passive: false });
                            cell.addEventListener('touchend', handleEditTouchEnd);
                            cell.addEventListener('touchcancel', handleEditTouchEnd);
                        } else {
                            cell.classList.add('locked');
                            cell.setAttribute('draggable', 'false');
                        }

                        // Create content wrapper for overflow clipping
                        const contentWrapper = document.createElement('div');
                        contentWrapper.className = 'cell-content';

                        if (item.isTextOnly) {
                            // Text-only cell: show centered text (large, prominent)
                            cell.classList.add('text-only-cell');
                            const textLabel = document.createElement('div');
                            textLabel.className = 'text-only-label';
                            textLabel.textContent = item.label;
                            // Use label color but let CSS handle the large size
                            textLabel.style.color = config.labelColor || '#000000';

                            // Apply Word Shape Contour (if active)
                            if (item.contourActive) {
                                textLabel.setAttribute('data-text', item.label);
                                textLabel.classList.add('text-cell-contour');

                                const width = item.contourWidth || 8;
                                const gap = (item.contourGap !== undefined) ? item.contourGap : 4;
                                const color = item.contourColor || '#ef4444';

                                // Determine gap background color (default to white if no custom BG)
                                const gapColor = item.customBgColor || '#ffffff';

                                // Use SVG Filter logic
                                const gapRadius = gap;
                                const totalRadius = gap + width;

                                // Gap layer uses closeCounters=true to fill letter holes
                                const gapFilter = getContourFilterUrl(gapRadius, gapColor, true);
                                const outlineFilter = getContourFilterUrl(totalRadius, color);

                                textLabel.style.setProperty('--contour-filter-gap', gapFilter);
                                textLabel.style.setProperty('--contour-filter-outline', outlineFilter);
                            }

                            contentWrapper.appendChild(textLabel);
                        } else if (item.isShape) {
                            // Shape cell: show emoji/symbol centered
                            cell.classList.add('shape-cell');
                            const shapeContainer = document.createElement('div');
                            shapeContainer.className = 'image-container';
                            shapeContainer.style.flexDirection = 'column';

                            const shapeSymbol = document.createElement('div');
                            shapeSymbol.className = 'shape-symbol';
                            shapeSymbol.textContent = item.symbol;
                            if (item.symbolColor) {
                                shapeSymbol.style.color = item.symbolColor;
                            }
                            shapeContainer.appendChild(shapeSymbol);

                            // Add text label if enabled
                            if (config.showLabels) {
                                const label = document.createElement('div');
                                label.className = 'label-text';
                                label.textContent = getSpeechLabel(item);
                                label.style.fontSize = `${config.labelSize}px`;
                                label.style.color = (config.labelColor || '#000000');

                                // Position label above or below based on config
                                if (config.labelPosition === 'above') {
                                    label.style.marginTop = '0';
                                    label.style.marginBottom = '2px';
                                    shapeContainer.insertBefore(label, shapeContainer.firstChild);
                                } else {
                                    label.style.marginTop = '4px';
                                    label.style.marginBottom = '0';
                                    shapeContainer.appendChild(label);
                                }
                            }

                            contentWrapper.appendChild(shapeContainer);
                        } else if (item.isArasaac || item.isMulberry || item.src) {
                            // ARASAAC, Mulberry, or regular image cell: show image and optional label
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'image-container';

                            const img = document.createElement('img');
                            img.src = item.src;

                            // Apply Fit Logic
                            if (config.fit === 'fit-tall') {
                                img.style.width = 'auto';
                                img.style.height = '100%';
                                img.style.maxWidth = 'none';
                                img.style.maxHeight = 'none';
                                img.style.objectFit = '';
                            } else if (config.fit === 'fit-wide') {
                                img.style.width = '100%';
                                img.style.height = 'auto';
                                img.style.maxWidth = 'none';
                                img.style.maxHeight = 'none';
                                img.style.objectFit = '';
                            } else {
                                // Standard modes (contain, cover, fill)
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.maxWidth = ''; // Reset
                                img.style.maxHeight = ''; // Reset
                                img.style.objectFit = config.fit;
                            }
                            // Add ARASAAC or Mulberry class for potential styling differences
                            if (item.isArasaac) {
                                img.classList.add('arasaac-image');
                            } else if (item.isMulberry) {
                                img.classList.add('mulberry-image');
                            }
                            imgContainer.appendChild(img);

                            // Add text label if enabled
                            if (config.showLabels) {
                                const label = document.createElement('div');
                                label.className = 'label-text';
                                label.textContent = getSpeechLabel(item);
                                label.style.fontSize = `${config.labelSize}px`;
                                label.style.color = (config.labelColor || '#000000');

                                // Position label above or below based on config
                                if (config.labelPosition === 'above') {
                                    label.style.marginTop = '0';
                                    label.style.marginBottom = '2px';
                                    imgContainer.style.flexDirection = 'column';
                                    imgContainer.insertBefore(label, imgContainer.firstChild);
                                } else {
                                    label.style.marginTop = '2px';
                                    label.style.marginBottom = '0';
                                    imgContainer.style.flexDirection = 'column';
                                    imgContainer.appendChild(label);
                                }
                            }

                            contentWrapper.appendChild(imgContainer);
                        }
                        cell.appendChild(contentWrapper);

                    } else {
                        cell.classList.add('empty');

                        if (config.mode === 'edit') {
                            // Empty cell with three buttons: Add Image, Add Text, Add Shape
                            cell.innerHTML = `
                                <div class="flex items-center justify-center gap-3 h-full w-full p-2">
                                    <button class="add-image-btn group flex flex-col items-center justify-center p-3 rounded-xl bg-white/80 hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition-all shadow-sm hover:shadow-md border border-slate-200/60 hover:border-blue-300 active:scale-95" title="Add Image">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 transition-transform group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
                                            <circle cx="9" cy="9" r="2" />
                                            <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
                                        </svg>
                                    </button>
                                    <button class="add-text-btn group flex flex-col items-center justify-center p-3 rounded-xl bg-white/80 hover:bg-violet-50 text-slate-400 hover:text-violet-600 transition-all shadow-sm hover:shadow-md border border-slate-200/60 hover:border-violet-300 active:scale-95" title="Add Text Label">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 transition-transform group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path d="M4 7V4h16v3"/>
                                            <path d="M9 20h6"/>
                                            <path d="M12 4v16"/>
                                        </svg>
                                    </button>
                                    <button class="add-shape-btn group flex flex-col items-center justify-center p-3 rounded-xl bg-white/80 hover:bg-amber-50 text-slate-400 hover:text-amber-600 transition-all shadow-sm hover:shadow-md border border-slate-200/60 hover:border-amber-300 active:scale-95" title="Add Shape/Emoji">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 transition-transform group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" />
                                        </svg>
                                    </button>
                                </div>
                            `;

                            // Add click handlers for the buttons
                            const addImageBtn = cell.querySelector('.add-image-btn');
                            const addTextBtn = cell.querySelector('.add-text-btn');
                            const addShapeBtn = cell.querySelector('.add-shape-btn');

                            addImageBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                triggerSingleUpload(index);
                            });

                            addTextBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                openTextLabelModal(index);
                            });

                            addShapeBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                openShapesModal(index);
                            });
                        }

                        cell.addEventListener('dragover', handleDragOver);
                        cell.addEventListener('dragenter', handleDragEnter);
                    }

                    if (config.mode === 'edit') {
                        cell.addEventListener('dragover', handleDragOver);
                        cell.addEventListener('dragenter', handleDragEnter);
                        cell.addEventListener('dragleave', handleDragLeave);
                        cell.addEventListener('drop', handleDrop);
                        cell.addEventListener('dragend', handleDragEnd);
                    }

                    gridContainer.appendChild(cell);
                }

                // Fit text-only labels after DOM is updated
                requestAnimationFrame(() => {
                    document.querySelectorAll('.text-only-cell').forEach(cell => {
                        const textLabel = cell.querySelector('.text-only-label');
                        if (textLabel) {
                            fitTextToContainer(textLabel, cell, 0.75);
                        }
                    });

                    // Size shape symbols to 60% of cell height
                    document.querySelectorAll('.shape-cell').forEach(cell => {
                        const shapeSymbol = cell.querySelector('.shape-symbol');
                        if (shapeSymbol) {
                            const cellHeight = cell.offsetHeight;
                            const targetSize = cellHeight * 0.60;
                            shapeSymbol.style.fontSize = `${targetSize}px`;
                        }
                    });
                });

                // Persist grid state (but not during game)
                if (!huntActive) {
                    saveToLocalStorage();
                }
            }

            function updateSettings() {
                const newCols = parseInt(colRange.value);
                const newRows = parseInt(rowRange.value);
                if (newCols !== config.cols || newRows !== config.rows) {
                    resizeGrid(newRows, newCols);
                }
                config.gap = parseInt(gapRange.value);
                config.fit = fitSelect.value;
                colVal.innerText = config.cols;
                rowVal.innerText = config.rows;
                gapVal.innerText = `${config.gap}px`;
                renderGrid();
                updatePresetHighlight();
            }

            colRange.addEventListener('input', updateSettings);
            rowRange.addEventListener('input', updateSettings);
            gapRange.addEventListener('input', updateSettings);
            fitSelect.addEventListener('change', updateSettings);

            // Simple, robust file loader
            fileInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (!files || files.length === 0) return;

                loadingOverlay.classList.remove('hidden');

                try {
                    // Convert all files to Base64 in parallel
                    const newItemsPromises = files.map(async file => {
                        const base64Src = await fileToBase64(file);
                        const label = formatLabel(file.name);
                        return {
                            src: base64Src,
                            label: label,
                            speechLabel: getSavedSpeechLabel(label)
                        };
                    });

                    const newItems = await Promise.all(newItemsPromises);

                    // Delay slightly to let UI update if needed, though we awaited already
                    setTimeout(() => {
                        try {
                            // processing continues...

                            let emptySlots = gridData.filter(x => x === null).length;
                            const required = newItems.length;

                            if (required > emptySlots) {
                                const totalNeeded = gridData.filter(x => x !== null).length + required;
                                const autoCols = Math.ceil(Math.sqrt(totalNeeded));
                                const autoRows = Math.ceil(totalNeeded / autoCols);
                                const safeCols = Math.min(Math.max(config.cols, autoCols), 6);
                                const safeRows = Math.min(Math.max(config.rows, autoRows), 6);
                                colRange.value = safeCols;
                                rowRange.value = safeRows;
                                resizeGrid(safeRows, safeCols);
                            }

                            let idx = 0;
                            for (let i = 0; i < gridData.length && idx < newItems.length; i++) {
                                if (gridData[i] === null) {
                                    gridData[i] = newItems[idx++];
                                }
                            }
                            renderGrid();
                        } catch (err) {
                            console.error(err);
                        } finally {
                            loadingOverlay.classList.add('hidden');
                            fileInput.value = '';
                        }
                    }, 50);
                } catch (err) {
                    console.error("Upload error:", err);
                    loadingOverlay.classList.add('hidden');
                }
            });

            // --- Single Cell Upload Logic ---
            const singleFileInput = document.getElementById('single-file-input');
            let targetUploadIndex = null;

            function triggerSingleUpload(index) {
                targetUploadIndex = index;
                singleFileInput.click();
            }

            singleFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file || targetUploadIndex === null) return;

                try {
                    const base64Src = await fileToBase64(file);
                    const label = formatLabel(file.name);
                    const newItem = {
                        src: base64Src,
                        label: label,
                        speechLabel: getSavedSpeechLabel(label)
                    };

                    gridData[targetUploadIndex] = newItem;
                    renderGrid();
                } catch (err) {
                    console.error('File read error:', err);
                    alert('Error reading file. Please try again.');
                }

                // Reset
                singleFileInput.value = '';
                targetUploadIndex = null;
            });

            let warningDismissed = false;
            function dismissWarning() {
                warningDismissed = true;
                document.getElementById('hidden-icons-warning').classList.add('hidden');
            }

            window.clearGrid = function () {
                if (confirm('Clear all symbols and reset settings? This cannot be undone.')) {
                    gridData = Array(config.rows * config.cols).fill(null);
                    warningDismissed = false; // Reset warning state on clear
                    clearLocalStorage(); // Clear saved session data
                    saveToLocalStorage(); // Save the cleared state
                    renderGrid();
                }
            }

            window.toggleFullScreen = function () {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            }

            // Load saved state on startup (must be after DOM elements defined)
            loadFromLocalStorage();

            // Initial label UI state
            labelsToggle.checked = !!config.showLabels;
            if (config.showLabels) {
                if (!config.labelColor) config.labelColor = '#000000';
                labelSizeControl.classList.remove('hidden');
                labelColorControl.classList.remove('hidden');
                labelPositionControl.classList.remove('hidden');
                labelColorSelect.value = config.labelColor;
                labelColorPicker.value = config.labelColor;
                labelPositionSelect.value = config.labelPosition || 'below';
            } else {
                labelSizeControl.classList.add('hidden');
                labelColorControl.classList.add('hidden');
                labelPositionControl.classList.add('hidden');
            }

            // Initial magnifier UI state
            if (config.magnify) {
                magnifyControls.classList.remove('hidden');
            } else {
                magnifyControls.classList.add('hidden');
            }

            renderGrid();

            // --- PWA Service Worker Registration ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }

            // --- Splash Screen Logic ---
            (function initSplash() {
                const splash = document.getElementById('splash-screen');
                const startBtn = document.getElementById('splash-start-btn');
                const splashToggle = document.getElementById('splash-audio-toggle');

                // Label Elements
                const labelTone = document.getElementById('label-tone');
                const labelVoice = document.getElementById('label-voice');

                if (!splash || !startBtn) return;

                // Load saved audio preference from localStorage
                const savedAudioPref = localStorage.getItem('aac_audioEnabled');
                let initialLoadComplete = false;

                if (savedAudioPref !== null) {
                    // User has a saved preference
                    const savedVal = savedAudioPref === 'true';
                    splashToggle.checked = savedVal;
                    config.audioEnabled = savedVal;
                    audioToggle.checked = savedVal;
                }

                function updateSplashAudioLabels(isChecked) {
                    if (!labelTone || !labelVoice) return;
                    if (isChecked) {
                        // Voice is ON
                        labelVoice.classList.replace('text-slate-400', 'text-blue-600');
                        labelTone.classList.replace('text-blue-600', 'text-slate-400');
                    } else {
                        // Voice is OFF (Tone is ON)
                        labelTone.classList.replace('text-slate-400', 'text-blue-600');
                        labelVoice.classList.replace('text-blue-600', 'text-slate-400');
                    }
                }

                // Sync toggle - only show help on user-initiated change TO voice
                splashToggle.addEventListener('change', () => {
                    config.audioEnabled = splashToggle.checked;
                    audioToggle.checked = splashToggle.checked;
                    updateSplashAudioLabels(splashToggle.checked);

                    // Only show naming help if:
                    // 1. User is switching TO Voice (checked)
                    // 2. Initial load is complete (not loading from localStorage)
                    if (splashToggle.checked && initialLoadComplete) {
                        const helpBtn = document.getElementById('splash-help-btn');
                        if (helpBtn) helpBtn.click();
                    }
                });

                // Initial state check (visual only, no modal)
                updateSplashAudioLabels(splashToggle.checked);

                // Mark initial load as complete after a brief delay
                setTimeout(() => { initialLoadComplete = true; }, 100);

                // Generic Modal Logic
                function setupModal(triggerId, modalId, closeId, okId, contentId) {
                    const trigger = document.getElementById(triggerId);
                    const modal = document.getElementById(modalId);
                    const closeBtn = document.getElementById(closeId);
                    const okBtn = document.getElementById(okId);
                    const content = document.getElementById(contentId);

                    if (!trigger || !modal || !content) return;

                    function open() {
                        modal.classList.remove('hidden');
                        void modal.offsetWidth; // trigger reflow
                        modal.classList.remove('opacity-0');
                        content.classList.remove('scale-95');
                        content.classList.add('scale-100');
                    }

                    function close() {
                        modal.classList.add('opacity-0');
                        content.classList.remove('scale-100');
                        content.classList.add('scale-95');
                        setTimeout(() => {
                            modal.classList.add('hidden');
                        }, 300);
                    }

                    trigger.addEventListener('click', open);
                    if (closeBtn) closeBtn.addEventListener('click', close);
                    if (okBtn) okBtn.addEventListener('click', close);

                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) close();
                    });
                }

                // Setup modals
                setupModal('splash-help-btn', 'splash-help-modal', 'splash-help-close', 'splash-help-ok-btn', 'splash-help-content');
                setupModal('splash-image-help-btn', 'splash-image-help-modal', 'splash-image-help-close', 'splash-image-help-ok-btn', 'splash-image-help-content');

                startBtn.addEventListener('click', () => {
                    // Final config sync
                    config.audioEnabled = splashToggle.checked;
                    audioToggle.checked = splashToggle.checked;
                    updateFeatures();

                    // Save audio preference to localStorage
                    localStorage.setItem('aac_audioEnabled', String(splashToggle.checked));

                    // Prime TTS engine with a silent utterance to unlock audio context
                    // This is required by browsers to allow speech synthesis on future calls
                    try {
                        const primer = new SpeechSynthesisUtterance('');
                        primer.volume = 0;
                        window.speechSynthesis.speak(primer);
                        window.speechSynthesis.cancel(); // Immediately cancel the silent utterance
                    } catch (e) {
                        // Ignore errors; this is just a primer
                    }

                    // Dismiss
                    splash.style.opacity = '0';
                    setTimeout(() => splash.remove(), 700);
                });
            })();


            window.setGridSize = function (cols, rows) {
                const colRange = document.getElementById('col-range');
                const rowRange = document.getElementById('row-range');

                colRange.value = cols;
                rowRange.value = rows;

                // Trigger update (this will also call updatePresetHighlight via updateSettings)
                colRange.dispatchEvent(new Event('input'));
            };

            function updatePresetHighlight() {
                const presets = document.querySelectorAll('.preset-btn');
                presets.forEach(btn => {
                    const pCols = parseInt(btn.dataset.cols);
                    const pRows = parseInt(btn.dataset.rows);
                    const label = btn.querySelector('.preset-label');
                    const originalText = `${pCols}x${pRows}`;

                    if (pCols === config.cols && pRows === config.rows) {
                        btn.classList.add('border-blue-600', 'bg-blue-50', 'ring-2', 'ring-blue-200');
                        btn.classList.remove('border-slate-200');
                        label.classList.add('text-blue-700', 'font-bold');
                        label.classList.remove('text-slate-500');
                        label.innerText = 'Selected';
                    } else {
                        btn.classList.remove('border-blue-600', 'bg-blue-50', 'ring-2', 'ring-blue-200');
                        btn.classList.add('border-slate-200');
                        label.classList.remove('text-blue-700', 'font-bold');
                        label.classList.add('text-slate-500');
                        label.innerText = originalText;
                    }
                });
            }

            // --- Debounced Resize ---
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    // Optional: Recalculate layout if needed, though CSS grid handles most
                    // This is a placeholder for future heavy resize logic
                }, 100);
            });

            // --- Prompts Modal Logic ---
            const promptsModal = document.getElementById('prompts-modal');
            const promptsInputsContainer = document.getElementById('prompts-inputs');
            const incorrectInputsContainer = document.getElementById('incorrect-inputs');
            const correctInputsContainer = document.getElementById('correct-inputs');

            window.openPromptsModal = function () {
                promptsModal.classList.remove('hidden');
                // Animate in
                setTimeout(() => {
                    promptsModal.querySelector('div[class*="translate-y-full"]').classList.remove('translate-y-full');
                }, 10);

                renderPromptsInputs();
            };

            window.closePromptsModal = function () {
                const modalContent = promptsModal.querySelector('div[class*="transition-transform"]');
                modalContent.classList.add('translate-y-full');
                setTimeout(() => {
                    promptsModal.classList.add('hidden');
                }, 300);
            };

            function createInputRow(value, placeholder) {
                const div = document.createElement('div');
                div.innerHTML = `
        <input type="text" value="${value}" placeholder="${placeholder}"
            class="w-full p-3 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-700 placeholder-slate-400">
            `;
                return div;
            }

            function renderPromptsInputs() {
                promptsInputsContainer.innerHTML = '';
                incorrectInputsContainer.innerHTML = '';
                correctInputsContainer.innerHTML = '';

                // Ensure we have at least 3 inputs for each, or use existing config
                const prompts = [...config.prompts];
                while (prompts.length < 3) prompts.push("");

                const incorrect = [...config.incorrectFeedback];
                while (incorrect.length < 3) incorrect.push("");

                const correct = [...config.correctFeedback];
                while (correct.length < 3) correct.push("");

                prompts.forEach(p => {
                    promptsInputsContainer.appendChild(createInputRow(p, "e.g. Find"));
                });

                incorrect.forEach(p => {
                    incorrectInputsContainer.appendChild(createInputRow(p, "e.g. That's [word], try again"));
                });

                correct.forEach(p => {
                    correctInputsContainer.appendChild(createInputRow(p, "e.g. Good job finding"));
                });
            }

            window.savePromptsSettings = function () {
                const getValues = (container) => {
                    return Array.from(container.querySelectorAll('input')).map(input => input.value);
                };

                config.prompts = getValues(promptsInputsContainer);
                config.incorrectFeedback = getValues(incorrectInputsContainer);
                config.correctFeedback = getValues(correctInputsContainer);

                closePromptsModal();

                // Optional: Show a toast or feedback that settings were saved
                const btn = document.querySelector('button[onclick="savePromptsSettings()"]');
                const originalText = btn.innerText;
                btn.innerText = "Saved!";
                setTimeout(() => btn.innerText = originalText, 2000);
            };

            // --- Bulk Symbol Modal Logic ---
            let bulkCollection = [];
            let currentBulkTab = 'arasaac';
            let lastBulkSearch = '';
            let bulkSearchTimeout = null;

            const bulkModal = document.getElementById('bulk-symbol-modal');
            const bulkSearchInput = document.getElementById('bulk-search-input');
            const bulkResultsContainer = document.getElementById('bulk-search-results');
            const bulkCollectionList = document.getElementById('bulk-collection-list');
            const bulkCountBadge = document.getElementById('bulk-count-badge');
            const bulkImportBtn = document.getElementById('bulk-import-btn');
            const bulkPopularContainer = document.getElementById('bulk-popular-tags');

            const bulkPopularTags = {
                'arasaac': ['happy', 'sad', 'eat', 'drink', 'help', 'play', 'more', 'stop', 'yes', 'no'],
                'mulberry': ['happy', 'sad', 'food', 'drink', 'help', 'work', 'home', 'person', 'yes', 'no']
            };

            window.openBulkSymbolModal = function () {
                bulkModal.classList.remove('hidden');
                // Reset to default state if needed, or keep previous state?
                // For now, let's keep the collection but maybe reset search
                if (!bulkSearchInput.value && currentBulkTab === 'arasaac') {
                    // Pre-load popular or clear
                }
                updateBulkPopularTags();
                renderBulkCollection();
                bulkSearchInput.focus();
            };

            window.closeBulkSymbolModal = function () {
                bulkModal.classList.add('hidden');
            };

            window.switchBulkSymbolTab = function (tabName) {
                currentBulkTab = tabName;

                // Update tabs UI
                document.getElementById('bulk-tab-arasaac').classList.toggle('active', tabName === 'arasaac');
                document.getElementById('bulk-tab-mulberry').classList.toggle('active', tabName === 'mulberry');

                // Update Placeholders
                if (tabName === 'arasaac') {
                    bulkSearchInput.placeholder = "Search ARASAAC line drawings...";
                } else {
                    bulkSearchInput.placeholder = "Search PiCom AI photographs...";
                }

                // Update Popular Tags
                updateBulkPopularTags();

                // Clear or Re-run search?
                // Let's re-run if there is a query
                if (bulkSearchInput.value.trim()) {
                    triggerBulkSearch(bulkSearchInput.value.trim());
                } else {
                    // Clear results
                    bulkResultsContainer.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-12 text-slate-400 opacity-60">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <p>Type to search symbols</p>
                        </div>`;
                }
            };

            function updateBulkPopularTags() {
                bulkPopularContainer.innerHTML = '';
                const tags = bulkPopularTags[currentBulkTab] || [];
                tags.forEach(tag => {
                    const btn = document.createElement('button');
                    btn.className = "px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs rounded-full transition-colors";
                    btn.innerText = tag;
                    btn.onclick = () => {
                        bulkSearchInput.value = tag;
                        triggerBulkSearch(tag);
                    };
                    bulkPopularContainer.appendChild(btn);
                });
            }

            // Search Handlers
            if (bulkSearchInput) {
                bulkSearchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    if (bulkSearchTimeout) clearTimeout(bulkSearchTimeout);
                    if (query.length < 2) return;

                    bulkSearchTimeout = setTimeout(() => {
                        triggerBulkSearch(query);
                    }, 400);
                });

                bulkSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        triggerBulkSearch(bulkSearchInput.value.trim());
                    }
                });
            }

            async function triggerBulkSearch(query) {
                if (!query || query.length < 2) return;

                bulkResultsContainer.innerHTML = '<div class="col-span-full py-8 text-center text-slate-500">Searching...</div>';

                if (currentBulkTab === 'arasaac') {
                    await searchBulkArasaac(query);
                } else {
                    await searchBulkMulberry(query);
                }
            }

            async function searchBulkArasaac(query) {
                try {
                    const response = await fetch(`${ARASAAC_API_BASE}/pictograms/en/search/${encodeURIComponent(query)}`);
                    if (!response.ok) throw new Error('Search failed');
                    const data = await response.json();
                    renderBulkResults(data, 'arasaac');
                } catch (e) {
                    bulkResultsContainer.innerHTML = '<div class="col-span-full py-8 text-center text-slate-400">No results found or error occurred.</div>';
                }
            }

            async function searchBulkMulberry(query) {
                try {
                    const apiUrl = `${PICOM_API_BASE}/labels/search?query=${encodeURIComponent(query)}&symbolset=${PICOM_SYMBOLSET}&language=en&language_iso_format=639-1&limit=24`;
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('Search failed');
                    const data = await response.json();
                    // Transform generic API response to our format
                    const mapped = data.map(item => ({
                        _id: item.picto?.id, // Use picto ID
                        keywords: [item.text], // Use label text
                        picto: item.picto // Keep structure similar to what displayMulberryResults expects
                    }));
                    renderBulkResults(mapped, 'mulberry');
                } catch (e) {
                    bulkResultsContainer.innerHTML = '<div class="col-span-full py-8 text-center text-slate-400">No results found or network error.</div>';
                }
            }

            function renderBulkResults(results, type) {
                if (!results || results.length === 0) {
                    bulkResultsContainer.innerHTML = '<div class="col-span-full py-8 text-center text-slate-400">No results found.</div>';
                    return;
                }

                bulkResultsContainer.innerHTML = '';
                results.forEach(item => {
                    const wrapper = document.createElement('div');

                    let imgSrc, label, id;
                    if (type === 'arasaac') {
                        id = item._id;
                        imgSrc = `${ARASAAC_API_BASE}/pictograms/${id}?download=false`;
                        label = item.keywords[0]?.keyword || 'Symbol';
                    } else {
                        // Mulberry/PiCom
                        // For PiCom, item.picto contains image_url
                        imgSrc = item.picto?.image_url;
                        label = item.keywords[0] || 'Symbol';
                        id = item._id;
                    }

                    // Check if already selected
                    const isSelected = bulkCollection.some(sc => sc.id == id && sc.type === type);

                    wrapper.className = `aspect-square bg-white border rounded-xl overflow-hidden flex flex-col items-center justify-center p-2 cursor-pointer transition-all hover:shadow-md relative group ${isSelected ? 'ring-2 ring-blue-500 border-blue-500' : 'border-slate-200 hover:border-blue-400'}`;

                    // Selection indicator
                    if (isSelected) {
                        wrapper.innerHTML += `<div class="absolute top-1 right-1 w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs z-10"></div>`;
                    }

                    wrapper.onclick = () => toggleBulkSelection(item, type, wrapper);

                    const img = document.createElement('img');
                    img.src = imgSrc;
                    img.className = "w-full h-2/3 object-contain pointer-events-none mb-1";

                    const text = document.createElement('span');
                    text.className = "text-[10px] text-center text-slate-600 line-clamp-1 w-full px-1";
                    text.innerText = label;

                    wrapper.appendChild(img);
                    wrapper.appendChild(text);
                    bulkResultsContainer.appendChild(wrapper);
                });
            }

            function toggleBulkSelection(item, type, element) {
                let id, imgSrc, label;

                if (type === 'arasaac') {
                    id = item._id;
                    imgSrc = `${ARASAAC_API_BASE}/pictograms/${id}?download=false`;
                    label = item.keywords[0]?.keyword || 'Symbol';
                } else {
                    id = item._id;
                    imgSrc = item.picto?.image_url;
                    label = item.keywords[0] || 'Symbol';
                }

                const existingIndex = bulkCollection.findIndex(sc => sc.id == id && sc.type === type);

                if (existingIndex >= 0) {
                    // Deselect
                    bulkCollection.splice(existingIndex, 1);
                    element.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
                    element.classList.add('border-slate-200');
                    // Remove checkmark
                    const check = element.querySelector('.bg-blue-500');
                    if (check) check.remove();
                } else {
                    // Select
                    bulkCollection.push({ id, type, imgSrc, label });
                    element.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
                    element.classList.remove('border-slate-200');
                    element.innerHTML += `<div class="absolute top-1 right-1 w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs z-10"></div>`;
                }

                renderBulkCollection();
                // renderBulkResults removed to prevent clearing search
            }

            function renderBulkCollection() {
                bulkCountBadge.innerText = bulkCollection.length;
                bulkImportBtn.disabled = bulkCollection.length === 0;
                bulkImportBtn.innerText = bulkCollection.length > 0 ? `Import ${bulkCollection.length} Symbols` : 'Import All';

                if (bulkCollection.length === 0) {
                    bulkCollectionList.innerHTML = `
                        <div id="bulk-collection-empty" class="h-full flex flex-col items-center justify-center text-slate-400 text-center p-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-2 opacity-50">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" x2="12" y1="3" y2="15"></line>
                            </svg>
                            <p class="text-xs">Select symbols to build your library</p>
                        </div>`;
                    return;
                }

                bulkCollectionList.innerHTML = '';
                bulkCollection.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = "flex items-center gap-2 p-2 bg-slate-50 rounded-lg border border-slate-100 group";

                    row.innerHTML = `
                        <img src="${item.imgSrc}" class="w-8 h-8 object-contain bg-white rounded border border-slate-200">
                        <span class="flex-1 text-xs font-medium text-slate-700 truncate">${item.label}</span>
                        <button onclick="removeFromBulkCollection(${index})" class="p-1 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    `;
                    bulkCollectionList.appendChild(row);
                });
            }

            window.removeFromBulkCollection = function (index) {
                bulkCollection.splice(index, 1);
                renderBulkCollection();
                // If possible, update the selection state in the result grid if visible
                if (currentBulkTab && bulkSearchInput.value) {
                    triggerBulkSearch(bulkSearchInput.value); // Brute force update to sync checks
                }
            };

            window.confirmBulkImport = function () {
                if (bulkCollection.length === 0) return;

                let addedCount = 0;

                // Helper to create grid item from bulk collection item
                const createGridItem = (item) => ({
                    isShape: false,
                    symbol: null,
                    src: item.imgSrc,
                    label: item.label,
                    isArasaac: item.type === 'arasaac',
                    isMulberry: item.type === 'mulberry',
                    customBgColor: null,
                    customBorderColor: null,
                    speechLabel: ''
                });

                // 1. Fill empty slots in the current grid
                for (let i = 0; i < gridData.length; i++) {
                    if (addedCount >= bulkCollection.length) break;

                    // Check if cell is empty (null or no content)
                    if (!gridData[i] || (!gridData[i].symbol && !gridData[i].src && !gridData[i].label)) {
                        gridData[i] = createGridItem(bulkCollection[addedCount]);
                        addedCount++;
                    }
                }

                // 2. Append any remaining items to the end of the grid (overflow)
                // These will be hidden initially (triggering "Hidden Symbols" warning)
                while (addedCount < bulkCollection.length) {
                    gridData.push(createGridItem(bulkCollection[addedCount]));
                    addedCount++;
                }

                renderGrid();
                saveToLocalStorage();

                // Clear collection after successful import
                bulkCollection = [];
                renderBulkCollection();

                closeBulkSymbolModal();
            };
        </script>
</body>

</html>